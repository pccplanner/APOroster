<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Tracker & Validator</title>
    
    <!-- Meta tags for Add to Home Screen (PWA/Mobile Shortcut) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Shift Tracker">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Theva73/shift_tracking/main/apple-touch-icon.png">
    <link rel="icon" href="https://raw.githubusercontent.com/Theva73/shift_tracking/main/apple-touch-icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tesseract.js for Image OCR -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- SheetJS (XLSX) for Excel parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #fdfbf6; padding-bottom: 100px; color: #3d3d3d; position: relative; overflow-x: hidden; }
        body::before, body::after { content: ''; position: fixed; border-radius: 50%; opacity: 0.5; filter: blur(80px); z-index: -1; }
        body::before { width: 300px; height: 300px; background: linear-gradient(to right, #e0c3fc, #8ec5fc); top: -100px; left: -100px; }
        body::after { width: 400px; height: 400px; background: linear-gradient(to right, #fbc2eb, #a6c1ee); bottom: -150px; right: -150px; }
        
        .glass-card { 
            background: rgba(255, 255, 255, 0.6); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1); 
        }

        .gradient-bg { background: linear-gradient(to right, #1e3a8a, #3b82f6); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1); }
        .overlay { transition: opacity 0.3s ease-in-out; }
        .overlay.hidden { pointer-events: none; }
        .bottom-sheet { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); transform: translateY(100%); }
        .overlay:not(.hidden) .bottom-sheet { transform: translateY(0); }
        #logger-card, #tools-card, #auth-card, #calendar-card, #team-manager-card, #edit-team-pattern-card, #report-card, #profile-card, #validation-card { border-radius: 1.5rem 1.5rem 0 0; }
        .glass-input { background-color: rgba(255, 255, 255, 0.5); border: 1px solid rgba(255, 255, 255, 0.3); }
        .team-selector-btn { border: 2px solid transparent; background-color: rgba(255, 255, 255, 0.3); transition: all 0.2s ease-in-out; }
        .team-selector-btn.active { border-color: #3b82f6; background-color: rgba(255, 255, 255, 0.7); }
        .location-tag, .ot-tag { padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 500; font-size: 0.8rem; display: inline-block; }
        
        #calendar-card {
            backdrop-filter: none !important; 
            -webkit-backdrop-filter: none !important;
            background: rgba(255, 255, 255, 0.95);
        }
        
        #calendar-grid { grid-auto-rows: minmax(6rem, auto); }
        .calendar-cell {
            background: none; 
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            min-height: 80px; 
            text-align: center;
        }
        .calendar-cell:not(.empty) { cursor: pointer; }
        .calendar-cell:not(.empty):hover { transform: scale(1.03); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15); z-index: 10; }
        .calendar-cell.empty { background-color: rgba(255, 255, 255, 0.1); opacity: 0.6; cursor: default; box-shadow: none; }
        .calendar-cell .day-num { font-weight: 700; font-size: 1rem; color: #333; flex-shrink: 0; text-align: right; margin-bottom: 4px; }
        .weekend { color: #c2410c; }
        
        .logged-shift-card {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            flex-grow: 1;
            padding: 0.3rem 0;
            border-radius: 0.5rem;
            background: rgba(255, 255, 255, 0.9); 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.5);
            min-height: 60px;
        }
        
        .shift-icon { height: 1.25rem; width: 1.25rem; margin-bottom: 2px; }
        .location-text {
            font-size: 0.7rem;
            font-weight: 600;
            width: 100%;
            padding: 0 4px;
            color: #333; 
            flex-shrink: 0;
            text-align: center;
            margin-top: 2px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            word-break: break-word; 
            line-height: 1.1; 
            height: 1.6rem;
        }
        
        .hours-text { font-size: 0.7rem; font-weight: 700; color: #1e3a8a; margin-top: 2px; }
        .ot-tag-cal { font-size: 0.6rem; font-weight: 700; color: #b45309; background-color: #fef3c7; padding: 0 4px; border-radius: 4px; margin-top: 2px; display: inline-block; }

        .shift-bg-Morning { background: linear-gradient(to bottom, #fffdf8, #fef9c3); }
        .shift-bg-Night { background: linear-gradient(to bottom, #f0f4ff, #c7d2fe); }
        .shift-bg-OFF { background: linear-gradient(to bottom, #f0fff4, #d1fae5); }
        .shift-bg-Other { background: linear-gradient(to bottom, #ffffff, #f3f4f6); }

        .auto-shift-card { opacity: 0.7; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; flex-grow: 1; font-weight: 700; color: #6b7280; }
        .auto-shift-text { font-size: 1rem; margin-top: 4px; }
        .night-icon-svg path { transform: translate(0, 0); }

        /* Validation Table Styles */
        .validation-row { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px; font-size: 0.8rem; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.3); align-items: center; }
        .validation-row:last-child { border-bottom: none; }
        .val-match { color: #15803d; font-weight: 600; }
        .val-mismatch { color: #b91c1c; font-weight: 700; background-color: #fee2e2; border-radius: 4px; }
        .val-missing { color: #854d0e; font-style: italic; }
    </style>

    <!-- PDF.js for PDF import (Data Extracted style) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
      if (window['pdfjsLib']) {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
      }
    </script>
</head>
<body>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">
         <header class="flex justify-between items-center mb-4">
             <h2 class="text-3xl font-bold text-center flex-grow">Shift Tracker</h2>
             <div class="text-right">
                 <p id="user-display" class="text-sm text-gray-600 truncate max-w-[150px]"></p>
                 <button id="auth-button" class="btn inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white/90 px-3 py-1.5 text-xs sm:text-sm font-semibold text-slate-800 shadow-sm hover:bg-slate-100">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500" viewBox="0 0 20 20" fill="currentColor">
                     <path fill-rule="evenodd" d="M3 4.5A1.5 1.5 0 014.5 3h5A1.5 1.5 0 0112 4.5V6h-1V4.5h-5v11h5V14h1v1.5a1.5 1.5 0 01-1.5 1.5h-5A1.5 1.5 0 013 15.5v-11zm9.854 3.646a.5.5 0 10-.708.708L13.293 10H8.5a.5.5 0 000 1h4.793l-1.147 1.146a.5.5 0 10.708.708l2.5-2.5a.5.5 0 000-.708l-2.5-2.5z" clip-rule="evenodd" />
                 </svg>
                 <span id="auth-label">Sign In</span>
             </button>
             </div>
         </header>

        <div id="global-error-banner" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert">
            <strong class="font-bold">Error!</strong>
            <span id="error-message" class="block sm:inline">An unexpected error occurred.</span>
        </div>
        
        <div id="app-content"><!-- Main content injected here --></div>
        
        <div id="sign-in-prompt" class="text-center py-16 card glass-card rounded-xl">
            <h3 class="text-xl font-bold">Welcome to Shift Tracker</h3>
            <p class="text-gray-600 mt-2">Please sign in or create an account.</p>
        </div>
    </div>
    
    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-end justify-center hidden z-50 opacity-0 overlay">
        <div id="auth-card" class="glass-card w-full max-w-md bottom-sheet p-6">
            <h2 class="text-2xl font-bold text-center mb-6">Sign In or Create Account</h2>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4 hidden" role="alert"></div>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="Email" class="glass-input w-full p-3 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
                <input type="password" id="password-input" placeholder="Password" class="glass-input w-full p-3 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500">
                <div id="signup-fields" class="space-y-4 hidden">
                    <div>
                        <label class="block text-sm font-medium mb-2 text-gray-700">Filter Location Access</label>
                        <div class="flex space-x-2">
                            <button type="button" data-location-filter="Sentry" class="filter-btn flex-1 p-2 rounded-lg border border-gray-300 bg-white/50 hover:bg-white/80 text-sm font-semibold text-gray-600 active:bg-blue-100 active:border-blue-500 active:text-blue-700">Sentry</button>
                            <button type="button" data-location-filter="Foyer" class="filter-btn flex-1 p-2 rounded-lg border border-gray-300 bg-white/50 hover:bg-white/80 text-sm font-semibold text-gray-600 active:bg-blue-100 active:border-blue-500 active:text-blue-700">Foyer</button>
                            <button type="button" data-location-filter="Both" class="filter-btn flex-1 p-2 rounded-lg border border-gray-300 bg-white/50 hover:bg-white/80 text-sm font-semibold text-gray-600 active:bg-blue-100 active:border-blue-500 active:text-blue-700 active">Both</button>
                        </div>
                        <input type="hidden" id="signup-location-filter" value="Both">
                        <p class="text-xs text-gray-500 mt-1">This sets which teams/locations are visible to you.</p>
                    </div>
                    <p class="text-sm font-medium text-gray-600">You can set your rotation pattern later in Advanced Tools.</p>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button id="signin-btn" class="btn bg-blue-600 text-white font-bold py-3 rounded-lg">Sign In</button>
                <button id="signup-btn" class="btn bg-green-600 text-white font-bold py-3 rounded-lg">Sign Up</button>
            </div>
             <button id="auth-cancel-btn" class="w-full text-center mt-4 text-gray-600 font-semibold py-2">Cancel</button>
        </div>
    </div>

    <!-- Main UI -->
    <div id="main-app-ui" class="hidden">
        <!-- Logger -->
        <div id="logger-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-end justify-center hidden z-40 opacity-0 overlay">
            <div id="logger-card" class="glass-card w-full max-w-4xl max-h-[90vh] overflow-y-auto bottom-sheet">
                <header class="flex justify-between items-center p-4 border-b border-white/20 sticky top-0 glass-card z-10 rounded-t-2xl">
                    <div class="flex items-center gap-2">
                        <h1 id="logger-title" class="text-xl font-bold">Log a New Shift</h1>
                        <button id="tools-button" class="text-gray-600 hover:text-black p-2 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" /></svg></button>
                    </div>
                    <button id="logger-done-button" class="font-semibold text-blue-600 py-2 px-4 rounded-lg hover:bg-white/50">Done</button>
                </header>
                <form id="shift-form">
                    <div class="p-6"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="space-y-4"><div><label for="shift-date" class="block text-sm font-medium mb-2">Date</label><input type="date" id="shift-date" class="glass-input w-full p-2.5 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div>
                        
                        <div id="shift-toggle-container">
                            <label class="block text-sm font-medium mb-2">Shift</label>
                            <div class="flex items-center gap-4 p-1 bg-white/30 rounded-lg">
                                <button type="button" id="morning-shift-btn" class="flex-1 p-2 rounded-md font-semibold text-gray-600">Morning</button>
                                <button type="button" id="night-shift-btn" class="flex-1 p-2 rounded-md font-semibold text-gray-600">Night</button>
                            </div>
                        </div>

                        <div><label class="block text-sm font-medium mb-2">Team</label><div class="grid grid-cols-3 gap-2">
                            <button type="button" id="sentry-tab" class="team-selector-btn p-3 rounded-lg flex flex-col items-center justify-center active"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1.944A11.954 11.954 0 012.166 5C2.056 5.649 2 6.319 2 7c0 5.225 3.34 9.67 8 11.317C14.66 16.67 18 12.225 18 7c0-.682-.057-1.35-.166-2.001A11.954 11.954 0 0110 1.944zM10 14a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg><span class="text-sm font-semibold mt-1">Sentry</span></button>
                            <button type="button" id="foyer-tab" class="team-selector-btn p-3 rounded-lg flex flex-col items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd" /></svg><span class="text-sm font-semibold mt-1">Foyer</span></button>
                            <button type="button" id="others-tab" class="team-selector-btn p-3 rounded-lg flex flex-col items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-700" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg><span class="text-sm font-semibold mt-1">Others</span></button>
                        </div></div></div><div class="space-y-4">
                        
                        <div id="duty-location-group">
                            <label for="duty-location" class="block text-sm font-medium mb-2">Duty / Location</label>
                            <select id="duty-location" class="glass-input w-full p-2.5 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-semibold"></select>
                            
                            <input type="text" id="redeploy-location-input" placeholder="ENTER ADHOC OR REDEPLOY DETAILS" 
                                   class="glass-input w-full p-2.5 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 mt-2 hidden uppercase placeholder:normal-case">
                        </div>
                        
                        <div><label class="block text-sm font-medium mb-2">Hours & Overtime</label><div class="flex items-center gap-4 p-3 bg-white/20 rounded-lg"><div class="flex-1"><label for="shift-hours" class="text-sm">Working Hours</label><input type="number" id="shift-hours" value="12" class="glass-input w-full mt-1 p-2 rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></div><div class="flex items-center pt-5"><input type="checkbox" id="is-ot" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 bg-white/50"><label for="is-ot" class="ml-2 text-sm font-medium">OT</label></div></div></div></div></div></div>
                </form>
                <div class="p-6 pt-0">
                    <button id="save-assignment-btn" class="btn w-full gradient-bg text-white font-bold py-3 px-4 rounded-lg shadow-lg">Log Assignment</button>
                </div>
            </div>
        </div>

        <!-- Calendar Overlay -->
        <div id="calendar-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-end justify-center hidden z-40 opacity-0 overlay">
            <div id="calendar-card" class="glass-card w-full max-w-4xl max-h-[90vh] overflow-y-auto bottom-sheet">
                <header class="flex justify-between items-center p-4 border-b border-white/20 sticky top-0 glass-card z-10 rounded-t-2xl">
                    <h1 id="calendar-title" class="text-xl font-bold">Monthly Calendar</h1>
                    <button id="calendar-close-button" class="font-semibold text-blue-600 py-2 px-4 rounded-lg hover:bg-white/50">Close</button>
                </header>
                <div class="p-4 sm:p-6">
                    <div id="calendar-weekdays" class="grid grid-cols-7 gap-2 mb-2"></div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-3"></div>
                </div>
            </div>
        </div>

        <!-- Team Manager Overlay -->
        <div id="team-manager-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-end justify-center hidden z-50 opacity-0 overlay">
             <div id="team-manager-card" class="glass-card w-full max-w-4xl bottom-sheet">
                <header class="flex justify-between items-center p-4 border-b border-white/20">
                   <h1 id="team-manager-title" class="text-xl font-bold">Team & Pattern Selection</h1>
                   <button id="team-manager-close-button" class="font-semibold text-blue-600 py-2 px-4 rounded-lg hover:bg-white/50">Close</button>
               </header>
               <div id="team-manager-content"></div>
           </div>
        </div>
        
        <!-- Edit Team Pattern Overlay -->
        <div id="edit-team-pattern-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-end justify-center hidden z-50 opacity-0 overlay">
             <div id="edit-team-pattern-card" class="glass-card w-full max-w-4xl max-h-[90vh] overflow-y-auto bottom-sheet">
                <header class="flex justify-between items-center p-4 border-b border-white/20">
                   <h1 id="edit-team-title" class="text-xl font-bold">Edit Pattern: New Team</h1>
                   <button id="edit-team-cancel-btn" class="font-semibold text-red-600 py-2 px-4 rounded-lg hover:bg-white/50">Cancel</button>
               </header>
               <div class="p-6 space-y-6">
                    <div>
                        <label for="team-name-input" class="block text-sm font-medium mb-1 text-gray-600">Team Name</label>
                        <input type="text" id="team-name-input" placeholder="e.g., Alpha Team" class="glass-input w-full p-2.5 rounded-lg shadow-sm text-lg font-semibold focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="pattern-length" class="block text-sm font-medium mb-1">Pattern Length</label>
                            <input type="number" id="pattern-length" min="1" max="30" value="6" class="glass-input w-full p-2.5 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="pattern-anchor-date" class="block text-sm font-medium mb-1">Pattern Anchor Date</label>
                            <input type="date" id="pattern-anchor-date" class="glass-input w-full p-2.5 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <p class="text-xs text-gray-600 mt-1">The "Day 1" of the rotation.</p>
                        </div>
                    </div>

                    <div>
                        <label class="block text-lg font-bold mb-3">Visual Pattern</label>
                        <p class="text-sm text-gray-600 mb-4">Click the cells below to cycle through shift types (Morning, Night, OFF).</p>
                        <div id="visual-pattern-grid" class="grid gap-3 grid-cols-3 sm:grid-cols-4 md:grid-cols-6"></div>
                    </div>

                    <button id="save-team-pattern-btn" class="btn w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg">Save Changes</button>
               </div>
           </div>
        </div>

        <!-- Profile Settings Overlay -->
        <div id="profile-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-end justify-center hidden z-50 opacity-0 overlay">
            <div id="profile-card" class="glass-card w-full max-w-lg bottom-sheet">
                <header class="flex justify-between items-center p-4 border-b border-white/20 sticky top-0 glass-card z-10 rounded-t-2xl">
                    <h1 class="text-xl font-bold">Profile Settings</h1>
                    <button id="profile-cancel-btn" class="font-semibold text-red-600 py-2 px-4 rounded-lg hover:bg-white/50">Cancel</button>
                </header>
                <div class="p-6 space-y-6">
                    <p class="text-sm text-gray-600">These details will be included in your generated reports.</p>
                    <div>
                        <label for="profile-name-input" class="block text-sm font-medium mb-1 text-gray-600">Full Name</label>
                        <input type="text" id="profile-name-input" placeholder="Your Name" class="glass-input w-full p-2.5 rounded-lg shadow-sm">
                    </div>
                     <div>
                        <label for="profile-employee-id-input" class="block text-sm font-medium mb-1 text-gray-600">Employee ID</label>
                        <input type="text" id="profile-employee-id-input" placeholder="e.g., T13904" class="glass-input w-full p-2.5 rounded-lg shadow-sm">
                    </div>
                    <button id="save-profile-btn" class="btn w-full gradient-bg text-white font-bold py-3 px-4 rounded-lg shadow-lg">Save Profile Details</button>
                </div>
            </div>
        </div>
        
        <!-- Validation Tool Overlay (UPDATED WITH IMAGE UPLOAD) -->
        <div id="validation-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-end justify-center hidden z-50 opacity-0 overlay">
            <div id="validation-card" class="glass-card w-full max-w-4xl max-h-[90vh] overflow-y-auto bottom-sheet">
                <header class="flex justify-between items-center p-4 border-b border-white/20 sticky top-0 glass-card z-10 rounded-t-2xl">
                    <h1 class="text-xl font-bold">Validate Working Hours</h1>
                    <button id="validation-close-button" class="font-semibold text-blue-600 py-2 px-4 rounded-lg hover:bg-white/50">Close</button>
                </header>
                <div class="p-6 space-y-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-bold text-blue-800 mb-2">How to use:</h3>
                        
                        <ol class="list-decimal list-inside text-sm text-blue-700 space-y-1">
                            <li><strong>Option 1:</strong> Upload a screenshot of your report.</li>
                            <li><strong>Option 2:</strong> Upload the exported <span class="font-semibold">RptAttendanceFlexible</span> Excel file.</li>
                            <li><strong>Option 3:</strong> Copy and paste the text from your report
                    
                    <!-- Import method tabs (Option C) -->
                    <div class="flex flex-wrap gap-2 mb-3" id="method-tabs">
                        <button type="button" data-method-tab="image"
                                class="method-tab px-3 py-1 rounded-full text-xs font-semibold border bg-blue-50 border-blue-300 text-blue-800 shadow-sm">
                            Image (Auto-Scan)
                        </button>
                        <button type="button" data-method-tab="csv"
                                class="method-tab px-3 py-1 rounded-full text-xs font-semibold border border-gray-300 text-gray-600 bg-white hover:bg-gray-50">
                            CSV / Excel
                        </button>
                        <button type="button" data-method-tab="pdf"
                                class="method-tab px-3 py-1 rounded-full text-xs font-semibold border border-gray-300 text-gray-600 bg-white hover:bg-gray-50">
                            PDF Report
                        </button>
                        <button type="button" data-method-tab="paste"
                                class="method-tab px-3 py-1 rounded-full text-xs font-semibold border border-gray-300 text-gray-600 bg-white hover:bg-gray-50">
                            Paste Text
                        </button>
                    </div>
<!-- NEW: Image Upload Section -->
                    <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4" data-method-pane="image">
                        <label class="block text-sm font-bold text-indigo-900 mb-2">Option 1: Upload Image (Auto-Scan)</label>
                        <div class="flex flex-col gap-2">
                            <input type="file" id="report-image-upload" accept="image/*"
                                   class="block w-full text-sm text-indigo-900
                                          file:mr-4 file:py-2 file:px-4
                                          file:rounded-md file:border-0
                                          file:text-sm file:font-semibold
                                          file:bg-indigo-100 file:text-indigo-700
                                          hover:file:bg-indigo-200 transition-colors" />
                            <div id="ocr-status" class="text-xs font-mono font-bold mt-1 hidden"></div>
                        </div>
                    </div>

                    <!-- NEW: Excel Upload Section -->
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4" data-method-pane="csv">
                        <label class="block text-sm font-bold text-green-900 mb-2">Option 2: Upload Excel (System Report)</label>
                        <p class="text-xs text-green-800 mb-2">
                            Select the exported <span class="font-semibold">RptAttendanceFlexible</span> Excel file from your system.
                            The system will read column <span class="font-mono">"DEEME&nbsp;D&nbsp;MTH"</span> for verification.
                        </p>
                        <div class="flex flex-col gap-2">
                            <input type="file" id="excel-upload" accept=".csv,.xls,.xlsx,.txt"
                                   class="block w-full text-sm text-green-900
                                          file:mr-4 file:py-2 file:px-4
                                          file:rounded-md file:border-0
                                          file:text-sm file:font-semibold
                                          file:bg-green-100 file:text-green-700
                                          hover:file:bg-green-200 transition-colors" />
                            <div id="excel-status" class="text-xs font-mono font-bold mt-1 hidden"></div>
                        </div>
                    </div>


                    <!-- NEW: PDF Upload Section (Data Extracted style) -->
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mt-3" data-method-pane="pdf">
                        <label class="block text-sm font-bold text-purple-900 mb-2">
                            Option 2B: Upload PDF (System Report)
                        </label>
                        <p class="text-xs text-purple-800 mb-2">
                            Upload the exported <span class="font-semibold">RptAttendanceFlexible</span> PDF report.
                            The system will scan for each <span class="font-mono">Clock Date</span> and its
                            <span class="font-mono">Deemed&nbsp;MTH</span> hours, then auto-fill the validation box below.
                        </p>
                        <div class="flex flex-col gap-2">
                            <input type="file" id="pdf-upload" accept=".pdf,.txt"
                                   class="block w-full text-sm text-purple-900
                                          file:mr-4 file:py-2 file:px-4
                                          file:rounded-md file:border-0
                                          file:text-sm file:font-semibold
                                          file:bg-purple-100 file:text-purple-700
                                          hover:file:bg-purple-200 transition-colors" />
                            <div id="pdf-status" class="text-xs font-mono font-bold mt-1 hidden"></div>
                        </div>
                    </div>

                    <div class="relative">
                        <div class="absolute inset-0 flex items-center" aria-hidden="true">
                            <div class="w-full border-t border-gray-300"></div>
                        </div>
                        <div class="relative flex justify-center">
                            <span class="px-2 bg-white/50 text-sm text-gray-500 font-medium">OR</span>
                        </div>
                    </div>

                    <div data-method-pane="paste">
                        <label class="block text-sm font-bold text-gray-700 mb-2">Option 3: Paste System Report Data Here</label>
                        <textarea id="validation-input" rows="5"
                                  class="w-full border border-gray-300 rounded-lg p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Paste text here or upload image/Excel above..."></textarea>
                    </div>
</textarea>
                    </div>
                    
                    <button id="analyze-validation-btn" class="btn w-full gradient-bg text-white font-bold py-3 px-4 rounded-lg shadow-lg">Analyze & Match</button>

                    <div id="validation-results" class="hidden">
                        <h3 class="font-bold text-lg mt-6 mb-2">Discrepancy Report (Matched against Deemed MTH)</h3>
                        <div class="overflow-x-auto">
                            <div class="grid grid-cols-4 gap-2 font-bold text-sm bg-white/50 p-2 rounded-t-lg border-b border-gray-300">
                                <div>Date</div>
                                <div>App Logged</div>
                                <div>System (Deemed)</div>
                                <div>Status</div>
                            </div>
                            <div id="validation-list" class="bg-white/30 rounded-b-lg border border-gray-200"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tools Overlay -->
        <div id="tools-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-end justify-center hidden z-50 opacity-0 overlay">
             <div id="tools-card" class="glass-card w-full max-w-4xl bottom-sheet">
                <header class="flex justify-between items-center p-4 border-b border-white/20">
                   <h1 class="text-xl font-bold">Advanced Tools</h1>
                   <button id="tools-close-button" class="font-semibold text-blue-600 py-2 px-4 rounded-lg hover:bg-white/50">Close</button>
               </header>
               <div class="p-6 space-y-4">
                    <button id="profile-settings-btn" class="btn w-full bg-white/50 border border-purple-600 text-purple-600 font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-white/80">Profile Settings</button>
                    <button id="manage-teams-btn" class="btn w-full bg-white/50 border border-indigo-600 text-indigo-600 font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-white/80">Team Settings</button>
                    <button id="generate-report-btn" class="btn w-full bg-white/50 border border-blue-600 text-blue-600 font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-white/80">Generate Report</button>
                    <!-- NEW BUTTON -->
                    <button id="open-validation-btn" class="btn w-full bg-white/50 border border-green-600 text-green-700 font-bold py-3 px-4 rounded-lg shadow-sm hover:bg-white/80 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                        Validate Working Hours
                    </button>
                    <button id="clear-history-btn" class="btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-md shadow-md">Clear History</button>
               </div>
           </div>
        </div>
        
        <!-- Report Generator Overlay -->
        <div id="report-generator-overlay" class="fixed inset-0 bg-black bg-opacity-30 flex items-end justify-center hidden z-50 opacity-0 overlay">
            <div id="report-card" class="glass-card w-full max-w-lg bottom-sheet">
                <header class="flex justify-between items-center p-4 border-b border-white/20 sticky top-0 glass-card z-10 rounded-t-2xl">
                    <h1 class="text-xl font-bold">Generate Custom Report</h1>
                    <button id="report-cancel-btn" class="font-semibold text-red-600 py-2 px-4 rounded-lg hover:bg-white/50">Cancel</button>
                </header>
                <div class="p-6 space-y-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">Report Date Range</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="start-date-input" class="block text-xs font-medium mb-1 text-gray-600">Start Date (Inclusive)</label>
                                <input type="date" id="start-date-input" class="glass-input w-full p-2.5 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label for="end-date-input" class="block text-xs font-medium mb-1 text-gray-600">End Date (Inclusive)</label>
                                <input type="date" id="end-date-input" class="glass-input w-full p-2.5 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">The report will cover all shifts logged between these two dates.</p>
                    </div>
                    
                    <button id="generate-custom-report-btn" class="btn w-full gradient-bg text-white font-bold py-3 px-4 rounded-lg shadow-lg">Generate Report</button>
                </div>
            </div>
        </div>
        
        <!-- Bottom Action Bar -->
        <div class="fixed bottom-0 left-0 right-0 bg-white/50 backdrop-blur-sm border-t border-white/30 p-4 z-30">
            <div class="container mx-auto max-w-4xl">
                <button id="log-new-shift-btn" class="btn w-full gradient-bg text-white font-bold py-3 px-4 rounded-full shadow-lg flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Log New Shift</span>
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-24 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transform translate-y-10 transition-all duration-300 z-50"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, doc, getDocs, updateDoc, setDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');

        window.onerror = function(message, source, lineno, colno, error) {
            const errorBanner = document.getElementById('global-error-banner');
            const errorMessage = document.getElementById('error-message');
            if (errorMessage) {
                errorMessage.textContent = `JS Error: ${message} (Line ${lineno})`;
                if (errorBanner) errorBanner.classList.remove('hidden');
            }
            console.error("Uncaught Global Error:", message, source, lineno, colno, error);
            return true;
        };

        const firebaseConfig = {
          apiKey: "AIzaSyD7EdbBA4e04e6XvxnPgFdqZo_9squYMg0",
          authDomain: "shift-tracker-b7879.firebaseapp.com",
          projectId: "shift-tracker-b7879",
          storageBucket: "shift-tracker-b7879.firebasestorage.app",
          messagingSenderId: "619413261457",
          appId: "1:619413261457:web:71bb4d19745a64aab20330",
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const CONTRACTUAL_HOURS = 240;
        let userId = null;
        let shiftsUnsubscribe = null;
        let teamsUnsubscribe = null;
        let profileUnsubscribe = null;
        let allShifts = [];
        let allTeams = [];
        let userProfile = { userTeamId: null, userLocationFilter: 'Both', userName: '', employeeId: '' }; 
        let isAdmin = false; 
        let editingTeam = null; 
        let displayedDate = new Date();
        let selectedShift = 'Morning';
        let selectedTeam = 'Sentry';
        let editingShiftId = null;
        let clearConfirmationTimeout = null;
        
        // --- CONSTANTS UPDATED TO UPPERCASE ---
        const REDEPLOY_MARKER = 'REDEPLOY LOCATION';
        const ADHOC_MARKER = 'ADHOC DETAILS'; 
        const TRAINING_MARKER = 'TRAINING'; // New marker for training input
        const OFF_DAY_MARKER = 'OFF DAY'; 
        
        const DUTY_LOCATIONS = { 
            Sentry: ['E1', 'GUARD HOUSE', 'ECHO 3', 'PATROL 1', 'OE / STANDBY', 'ECHO 2', 'PATROL 2', 'N1 (CNB DST)'], 
            Foyer: ['VISITOR X-RAY', 'STAFF X-RAY', 'N1 (CNB DST)', 'OE / STANDBY', 'VERTICAL PROWLER'], 
            Others: [TRAINING_MARKER, 'AL', 'MC', OFF_DAY_MARKER, REDEPLOY_MARKER, ADHOC_MARKER, 'TBC'] 
        };
        const SHIFT_TEAMS = ['Sentry', 'Foyer', 'Others'];
        const SHIFT_TYPES = ['M', 'N', 'OFF']; 
        const LOCATION_FILTERS = ['Sentry', 'Foyer', 'Both'];
        
        // Ensure keys match the uppercase values + original case for backward compatibility
        const LOCATION_COLORS = { 
            'E1': { bg: 'bg-blue-100', text: 'text-blue-800', hex: '#dbeafe' }, 
            'GUARD HOUSE': { bg: 'bg-emerald-100', text: 'text-emerald-800', hex: '#d1fae5' }, 
            'ECHO 3': { bg: 'bg-orange-100', text: 'text-orange-800', hex: '#ffedd5' }, 
            'PATROL 1': { bg: 'bg-violet-100', text: 'text-violet-800', hex: '#ede9fe' }, 
            'OE / STANDBY': { bg: 'bg-gray-200', text: 'text-gray-800', hex: '#e5e7eb' }, 
            'ECHO 2': { bg: 'bg-pink-100', text: 'text-pink-800', hex: '#fce7f3' }, 
            'PATROL 2': { bg: 'bg-teal-100', text: 'text-teal-800', hex: '#ccfbf1' }, 
            'VISITOR X-RAY': { bg: 'bg-red-100', text: 'text-red-800', hex: '#fee2e2' }, 
            'STAFF X-RAY': { bg: 'bg-amber-100', text: 'text-amber-800', hex: '#fef3c7' }, 
            'N1 (CNB DST)': { bg: 'bg-indigo-100', text: 'text-indigo-800', hex: '#e0e7ff' }, 
            'VERTICAL PROWLER': { bg: 'bg-cyan-100', text: 'text-cyan-800', hex: '#cffafe' }, 
            // Mixed case keys for backward compatibility
            'Training': { bg: 'bg-lime-100', text: 'text-lime-800', hex: '#f0fdf4' }, 
            'AdHoc': { bg: 'bg-fuchsia-100', text: 'text-fuchsia-800', hex: '#fae8ff' }, 
            'AL': { bg: 'bg-sky-100', text: 'text-sky-800', hex: '#e0f2fe' }, 
            'MC': { bg: 'bg-rose-100', text: 'text-rose-800', hex: '#ffe4e6' }, 
            // Uppercase keys for new data
            [TRAINING_MARKER]: { bg: 'bg-lime-100', text: 'text-lime-800', hex: '#f0fdf4' }, 
            'AL': { bg: 'bg-sky-100', text: 'text-sky-800', hex: '#e0f2fe' }, 
            'MC': { bg: 'bg-rose-100', text: 'text-rose-800', hex: '#ffe4e6' }, 
            'OT': { bg: 'bg-amber-100', text: 'text-amber-800', hex: '#fef3c7' },
            [OFF_DAY_MARKER]: { bg: 'bg-green-100', text: 'text-green-800', hex: '#dcfce7' },
            [REDEPLOY_MARKER]: { bg: 'bg-purple-100', text: 'text-purple-800', hex: '#f3e8ff' },
            [ADHOC_MARKER]: { bg: 'bg-fuchsia-100', text: 'text-fuchsia-800', hex: '#fae8ff' },
            'TBC': { bg: 'bg-slate-100', text: 'text-slate-800', hex: '#f1f5f9' },
            'FIRST AID': { bg: 'bg-red-100', text: 'text-red-800', hex: '#fee2e2' },
            'AED': { bg: 'bg-red-100', text: 'text-red-800', hex: '#fee2e2' },
            'CNB': { bg: 'bg-red-100', text: 'text-red-800', hex: '#fee2e2' }
        };
        const ICONS = { 
            morning: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-amber-500 shift-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`, 
            night: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-700 shift-icon night-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" transform="translate(0, 0)"></path></svg>`, 
            others: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 shift-icon" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>`,
            sentry: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1.944A11.954 11.954 0 012.166 5C2.056 5.649 2 6.319 2 7c0 5.225 3.34 9.67 8 11.317C14.66 16.67 18 12.225 18 7c0-.682-.057-1.35-.166-2.001A11.954 11.954 0 0110 1.944zM10 14a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>`, 
            foyer: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1.5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd" /></svg>` 
        };
        const WEEKDAYS = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
        const ADMIN_EMAILS = ['tvarajan7@gmail.com'];
        let SHARED_TEAMS_PATH = '';

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                isAdmin = ADMIN_EMAILS.includes(user.email);
                SHARED_TEAMS_PATH = `users/${user.uid}/teams`;
                updateUIForUser(user);
                setupDataListeners(); 
            } else {
                userId = null;
                isAdmin = false; 
                SHARED_TEAMS_PATH = '';
                if (shiftsUnsubscribe) shiftsUnsubscribe();
                if (teamsUnsubscribe) teamsUnsubscribe();
                if (profileUnsubscribe) profileUnsubscribe();
                allShifts = [];
                allTeams = [];
                userProfile = { userTeamId: null, userLocationFilter: 'Both', userName: '', employeeId: '' }; 
                updateUIForGuest();
            }
        });

        function updateUIForUser(user) {
            document.getElementById('user-display').textContent = user.email || 'Anonymous';
            document.getElementById('auth-label').textContent = 'Sign Out';
            document.getElementById('sign-in-prompt').classList.add('hidden');
            document.getElementById('main-app-ui').classList.remove('hidden');
            
            document.getElementById('app-content').innerHTML = `
                <div class="space-y-6">
                    <div class="card glass-card rounded-xl p-4">
                        <div class="flex justify-between items-center mb-4">
                            <button id="prev-month-btn" class="p-2 rounded-full hover:bg-white/50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                            <h3 id="month-display" class="text-lg font-bold text-center"></h3>
                            <button id="next-month-btn" class="p-2 rounded-full hover:bg-white/50"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center">
                            <div><p class="text-sm text-gray-700">Planned Hours</p><p id="planned-hours" class="text-xl font-bold text-blue-700">0</p></div>
                            <div><p class="text-sm text-gray-700">Logged Hours</p><p id="logged-hours" class="text-xl font-bold text-indigo-700">0</p></div>
                            <div><p class="text-sm text-gray-700">Overtime Hours</p><p id="ot-hours" class="text-xl font-bold text-amber-600">0</p></div>
                        </div>
                        <div class="mt-4">
                            <button id="calendar-view-btn" class="btn w-full bg-white/50 border border-blue-600 text-blue-600 font-bold py-2 px-4 rounded-lg shadow-sm hover:bg-white/80 flex items-center justify-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" />
                                </svg>
                                Calendar View
                            </button>
                        </div>
                    </div>

                    <!-- UPDATED: Search Filter with Icon -->
                    <div class="mb-2 relative">
                         <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                            </svg>
                        </div>
                        <input type="text" id="history-search" placeholder="Search history (e.g. E1, Patrol)..." class="glass-input w-full pl-10 pr-12 p-3 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button type="button" id="history-validation-btn"
                                class="absolute inset-y-0 right-2 flex items-center justify-center px-2 rounded-full text-green-700 hover:bg-green-100 focus:outline-none focus:ring-2 focus:ring-green-500"
                                title="Validate with system report">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 2a6 6 0 100 12A6 6 0 0010 2zM8.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l3.5-3.5a1 1 0 00-1.414-1.414L10 10.586 8.707 9.293z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    <p id="search-stats" class="text-sm text-blue-800 font-semibold mt-1 mb-2 text-right hidden"></p>

                    <div id="history-list" class="space-y-0"></div>
                    <p id="no-history" class="text-center text-gray-700 py-8 card glass-card rounded-xl">No shifts recorded for this month.</p>
                </div>`;
            
            document.getElementById('prev-month-btn').addEventListener('click', () => changeMonth(-1));
            document.getElementById('next-month-btn').addEventListener('click', () => changeMonth(1));
            document.getElementById('calendar-view-btn').addEventListener('click', openCalendarView);
            document.getElementById('history-search').addEventListener('input', () => renderHistory());

            const historyValidationBtn = document.getElementById('history-validation-btn');
            if (historyValidationBtn) {
                historyValidationBtn.addEventListener('click', () => openValidationOverlay(false));
            }

            const manageTeamsBtn = document.getElementById('manage-teams-btn');
            if (manageTeamsBtn) {
                if (!isAdmin) {
                    manageTeamsBtn.textContent = 'Team & Pattern Selection';
                } else {
                    manageTeamsBtn.textContent = 'Manage Teams & Patterns';
                }
                manageTeamsBtn.classList.remove('hidden');
            }
            renderHistory();
        }

        function updateUIForGuest() {
            document.getElementById('user-display').textContent = '';
            document.getElementById('auth-label').textContent = 'Sign In';
            document.getElementById('sign-in-prompt').classList.remove('hidden');
            document.getElementById('main-app-ui').classList.add('hidden');
            document.getElementById('app-content').innerHTML = '';
        }

        function setupDataListeners() {
            if (shiftsUnsubscribe) shiftsUnsubscribe();
            if (teamsUnsubscribe) teamsUnsubscribe();
            if (profileUnsubscribe) profileUnsubscribe();
            if (!userId) return;

            shiftsUnsubscribe = onSnapshot(collection(db, `users/${userId}/shifts`), (querySnapshot) => {
                const fetchedShifts = [];
                querySnapshot.forEach((doc) => fetchedShifts.push({ id: doc.id, ...doc.data() }));
                allShifts = fetchedShifts.sort((a, b) => new Date(b.rawDate + 'T00:00:00') - new Date(a.rawDate + 'T00:00:00'));
                renderHistory();
            });
            
            teamsUnsubscribe = onSnapshot(collection(db, `users/${userId}/teams`), (querySnapshot) => {
                allTeams = [];
                querySnapshot.forEach((docSnap) => {
                    allTeams.push({ id: docSnap.id, ...docSnap.data() });
                });
                if (!document.getElementById('team-manager-overlay').classList.contains('hidden')) renderTeamManagerList();
                renderHistory();
            });

            profileUnsubscribe = onSnapshot(doc(db, `users/${userId}/settings`, 'profile'), (docSnap) => {
                if (docSnap.exists()) {
                    userProfile = {
                        userTeamId: docSnap.data().userTeamId || null,
                        userLocationFilter: docSnap.data().userLocationFilter || 'Both',
                        userName: docSnap.data().userName || '',
                        employeeId: docSnap.data().employeeId || '', 
                    };
                } else {
                    userProfile = { userTeamId: null, userLocationFilter: 'Both', userName: '', employeeId: '' };
                }
                if (!document.getElementById('profile-overlay').classList.contains('hidden')) loadProfileSettings();
                renderHistory(); 
            });
        }

        function openProfileSettings() {
            loadProfileSettings();
            toggleOverlay('profile-overlay');
            toggleOverlay('tools-overlay');
        }
        
        function loadProfileSettings() {
            document.getElementById('profile-name-input').value = userProfile.userName;
            document.getElementById('profile-employee-id-input').value = userProfile.employeeId;
        }

        async function saveProfileSettings() {
            if (!userId) return showToast('You must be signed in.', true); 
            const userName = document.getElementById('profile-name-input').value.trim();
            const employeeId = document.getElementById('profile-employee-id-input').value.trim();
            try {
                await setDoc(doc(db, `users/${userId}/settings`, 'profile'), { userName, employeeId }, { merge: true });
                showToast('Profile details saved!');
                toggleOverlay('profile-overlay');
            } catch (error) {
                console.error("Error saving profile:", error);
                showToast('Failed to save profile.', true);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateUIForGuest(); 
            document.getElementById('auth-button').addEventListener('click', () => { 
                if (auth.currentUser) {
                    signOut(auth);
                } else {
                    toggleOverlay('auth-overlay');
                    document.getElementById('signup-fields').classList.add('hidden');
                }
            });
            document.getElementById('auth-cancel-btn').addEventListener('click', () => toggleOverlay('auth-overlay'));
            
            document.getElementById('signin-btn').addEventListener('click', handleSignIn);
            document.getElementById('signup-btn').addEventListener('click', () => {
                const fields = document.getElementById('signup-fields');
                const passwordInput = document.getElementById('password-input');
                if (fields.classList.contains('hidden')) {
                    fields.classList.remove('hidden');
                    passwordInput.focus();
                } else {
                    handleSignUp();
                }
            });

            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById('signup-location-filter').value = this.dataset.locationFilter;
                });
            });

            document.getElementById('log-new-shift-btn').addEventListener('click', () => prepareNewShift(null, null));
            document.getElementById('logger-done-button').addEventListener('click', () => toggleOverlay('logger-overlay'));
            document.getElementById('tools-button').addEventListener('click', () => toggleOverlay('tools-overlay'));
            document.getElementById('tools-close-button').addEventListener('click', () => toggleOverlay('tools-overlay'));
            document.getElementById('save-assignment-btn').addEventListener('click', saveAssignment);
            
            document.getElementById('generate-report-btn').addEventListener('click', openReportGenerator);
            document.getElementById('profile-settings-btn').addEventListener('click', openProfileSettings);
            document.getElementById('save-profile-btn').addEventListener('click', saveProfileSettings);
            document.getElementById('profile-cancel-btn').addEventListener('click', () => toggleOverlay('profile-overlay'));

            document.getElementById('report-cancel-btn').addEventListener('click', () => toggleOverlay('report-generator-overlay'));
            document.getElementById('generate-custom-report-btn').addEventListener('click', generateCustomReport);

            document.getElementById('clear-history-btn').addEventListener('click', handleClearHistory);
            document.getElementById('morning-shift-btn').addEventListener('click', () => selectShift('Morning'));
            document.getElementById('night-shift-btn').addEventListener('click', () => selectShift('Night'));
            
            document.getElementById('sentry-tab').addEventListener('click', () => selectTeam('Sentry'));
            document.getElementById('foyer-tab').addEventListener('click', () => selectTeam('Foyer'));
            document.getElementById('others-tab').addEventListener('click', () => selectTeam('Others'));
            
            document.getElementById('duty-location').addEventListener('change', updateRedeployInputVisibility);

            document.getElementById('calendar-close-button').addEventListener('click', () => toggleOverlay('calendar-overlay'));

            document.getElementById('manage-teams-btn').addEventListener('click', openTeamManager);
            document.getElementById('team-manager-close-button').addEventListener('click', () => toggleOverlay('team-manager-overlay'));
            
            document.getElementById('edit-team-cancel-btn').addEventListener('click', () => toggleOverlay('edit-team-pattern-overlay'));
            document.getElementById('save-team-pattern-btn').addEventListener('click', saveTeamPattern);
            document.getElementById('pattern-length').addEventListener('input', handlePatternLengthChange);
            document.getElementById('visual-pattern-grid').addEventListener('click', handlePatternCellClick);

            // Validation Tool Listeners
            document.getElementById('open-validation-btn').addEventListener('click', () => {
                openValidationOverlay(true);
            });
            const historyValidationBtn = document.getElementById('history-validation-btn');
            if (historyValidationBtn) {
                historyValidationBtn.addEventListener('click', () => {
                    openValidationOverlay(false);
                });
            }
document.getElementById('validation-close-button').addEventListener('click', () => toggleOverlay('validation-overlay'));
            document.getElementById('analyze-validation-btn').addEventListener('click', runValidationAnalysis);
            document.getElementById('report-image-upload').addEventListener('change', handleImageUpload);
        });

        async function handleSignIn() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const authErrorDiv = document.getElementById('auth-error');
            authErrorDiv.classList.add('hidden');
            try {
                await signInWithEmailAndPassword(auth, email, password);
                toggleOverlay('auth-overlay');
            } catch (error) {
                authErrorDiv.textContent = error.message;
                authErrorDiv.classList.remove('hidden');
            }
        }
        async function handleSignUp() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const locationFilter = document.getElementById('signup-location-filter').value; 
            const authErrorDiv = document.getElementById('auth-error');
            authErrorDiv.classList.add('hidden');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await setDoc(doc(db, `users/${userCredential.user.uid}/settings`, 'profile'), { 
                    userLocationFilter: locationFilter,
                    userName: '',
                    employeeId: '',
                }, { merge: true });
                toggleOverlay('auth-overlay');
                showToast(`Sign up successful! Location filter set to ${locationFilter}.`);
            } catch (error) {
                authErrorDiv.textContent = error.message;
                authErrorDiv.classList.remove('hidden');
            }
        }
        
        function toggleOverlay(overlayId) {
            const overlay = document.getElementById(overlayId);
            if (overlay.classList.contains('hidden')) {
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 400);
            }
        }
        function openValidationOverlay(fromTools) {
            if (fromTools) {
                toggleOverlay('tools-overlay');
            }
            toggleOverlay('validation-overlay');

            const resultsEl = document.getElementById('validation-results');
            if (resultsEl) resultsEl.classList.add('hidden');

            const textArea = document.getElementById('validation-input');
            if (textArea) textArea.value = '';

            const imgInput = document.getElementById('report-image-upload');
            if (imgInput) imgInput.value = '';

            const ocrStatus = document.getElementById('ocr-status');
            if (ocrStatus) ocrStatus.classList.add('hidden');
        }


        function changeMonth(direction) {
            displayedDate.setMonth(displayedDate.getMonth() + direction);
            renderHistory();
        }

        function isTeamRelevant(team) {
            const filter = userProfile.userLocationFilter;
            if (filter === 'Both') return true;
            if (filter === 'Sentry') return team === 'Sentry' || team === 'Others';
            if (filter === 'Foyer') return team === 'Foyer' || team === 'Others';
            return false;
        }

        window.toggleShiftDetails = (shiftId) => {
            const detailsElement = document.getElementById(`details-${shiftId}`);
            const chevronElement = document.getElementById(`chevron-${shiftId}`);
            if (detailsElement.classList.contains('hidden')) {
                detailsElement.classList.remove('hidden');
                chevronElement.classList.add('rotate-180');
            } else {
                detailsElement.classList.add('hidden');
                chevronElement.classList.remove('rotate-180');
            }
        }

        function renderHistory() {
            if (!document.getElementById('month-display')) return;
            const year = displayedDate.getFullYear();
            const month = displayedDate.getMonth();
            document.getElementById('month-display').textContent = displayedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const filteredShifts = allShifts.filter(s => isTeamRelevant(s.team));
            const shiftsForMonth = filteredShifts.filter(s => {
                const shiftDate = new Date(s.rawDate + 'T00:00:00');
                return shiftDate.getFullYear() === year && shiftDate.getMonth() === month;
            });
            
            const loggedHours = shiftsForMonth.reduce((acc, s) => acc + s.hours, 0);
            const plannedHours = CONTRACTUAL_HOURS;
            const otHours = Math.max(0, loggedHours - CONTRACTUAL_HOURS);
            
            document.getElementById('planned-hours').textContent = plannedHours;
            document.getElementById('logged-hours').textContent = loggedHours;
            document.getElementById('ot-hours').textContent = otHours;

            const searchInput = document.getElementById('history-search');
            const searchStats = document.getElementById('search-stats');
            let displayedShifts = shiftsForMonth;
            
            if (searchInput && searchInput.value.trim() !== '') {
                const searchTerm = searchInput.value.toLowerCase().trim();
                displayedShifts = shiftsForMonth.filter(s => {
                    const loc = s.location.toLowerCase();
                    const team = s.team.toLowerCase();
                    const cleanLoc = loc.replace('adhoc_', '').replace('redeploy_', '').replace('training_', '');
                    return loc.includes(searchTerm) || cleanLoc.includes(searchTerm) || team.includes(searchTerm);
                });
                
                if (displayedShifts.length > 0) {
                     const totalSearchHours = displayedShifts.reduce((acc, s) => acc + s.hours, 0);
                     searchStats.textContent = `Found ${displayedShifts.length} shifts matching "${searchInput.value}" (${totalSearchHours} hrs)`;
                     searchStats.classList.remove('hidden', 'text-red-500');
                     searchStats.classList.add('text-blue-800');
                } else {
                     searchStats.textContent = `No shifts found matching "${searchInput.value}"`;
                     searchStats.classList.remove('hidden', 'text-blue-800');
                     searchStats.classList.add('text-red-500');
                }
            } else {
                if (searchStats) searchStats.classList.add('hidden');
            }

            const historyList = document.getElementById('history-list');
            const noHistory = document.getElementById('no-history');
            
            if (shiftsForMonth.length === 0) {
                 noHistory.style.display = 'block';
                 noHistory.textContent = 'No shifts recorded for this month.';
                 historyList.style.display = 'none';
            } else if (displayedShifts.length === 0) {
                 noHistory.style.display = 'none';
                 historyList.innerHTML = '';
                 historyList.style.display = 'block';
            } else {
                 noHistory.style.display = 'none';
                 historyList.style.display = 'block';
            }
            
            const sortedList = [...displayedShifts].sort((a, b) => new Date(b.rawDate) - new Date(b.rawDate));
            if (sortedList.length === 0 && shiftsForMonth.length > 0) return; 

            const shiftsHTML = sortedList.map(shift => {
                let displayLocation = shift.location;
                let colorKey = shift.location;
                
                if (displayLocation.startsWith('AdHoc_')) {
                    displayLocation = `ADHOC: ${displayLocation.replace('AdHoc_', '')}`;
                    colorKey = ADHOC_MARKER;
                } else if (displayLocation.startsWith('Redeploy_')) {
                    displayLocation = `REDEPLOY: ${displayLocation.replace('Redeploy_', '')}`;
                    colorKey = REDEPLOY_MARKER;
                } else if (displayLocation.startsWith('Training_')) {
                    displayLocation = `TRAINING: ${displayLocation.replace('Training_', '')}`;
                    colorKey = TRAINING_MARKER;
                }
                
                // Ensure colorKey matches one of our keys (which might be mixed case or uppercase)
                // Try direct match, then uppercase match
                let colorInfo = LOCATION_COLORS[colorKey] || LOCATION_COLORS[colorKey.toUpperCase()] || LOCATION_COLORS[REDEPLOY_MARKER] || { bg: 'bg-gray-100', text: 'text-gray-800' };
                
                let shiftIcon = (shift.shift === 'Morning') ? ICONS.morning : (shift.shift === 'Night' ? ICONS.night : ICONS.others);
                const shiftDate = new Date(shift.rawDate + 'T00:00:00');

                return `<div class="shift-entry border-b border-white/20 last:border-b-0">
                    <div class="flex items-center justify-between p-3 cursor-pointer hover:bg-white/30" onclick="window.toggleShiftDetails('${shift.id}')">
                        <div class="flex items-center gap-4 flex-grow">
                            <div class="flex-shrink-0 text-center w-14">
                                <p class="font-bold text-lg">${shiftDate.getDate()}</p>
                                <p class="text-xs text-gray-600 uppercase">${shiftDate.toLocaleDateString('en-US', { weekday: 'short' })}</p>
                            </div>
                            <div class="pl-4 border-l border-white/20">${shiftIcon}</div>
                            <span class="location-tag font-bold ${colorInfo.bg} ${colorInfo.text}">${displayLocation.toUpperCase()}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-bold text-gray-700">${shift.hours}h</span>
                            ${shift.isOT ? `<span class="ot-tag bg-amber-100 text-amber-800">OT</span>` : '<span class="w-10"></span>'}
                            <svg id="chevron-${shift.id}" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </div>
                    </div>
                    <div id="details-${shift.id}" class="hidden p-3 pt-0 pl-24 bg-black/5">
                        <div class="space-y-2 text-sm">
                            <p class="font-medium text-gray-700">${shiftDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
                            <p class="font-semibold">${shift.shift} (${shift.shiftTime})</p>
                            <div class="flex items-center text-gray-600">
                                <span>${shift.hours} hrs</span>
                                <span class="mx-2">|</span>
                                ${ICONS[shift.team.toLowerCase()]}
                                <span>${shift.team === 'Others' ? 'Duty' : shift.team + ' Team'}</span>
                            </div>
                            <div class="flex items-center gap-4 mt-2">
                                <button onclick="window.prepareEditShift('${shift.id}')" class="text-blue-500 hover:text-blue-700 font-semibold flex items-center gap-1 text-xs">Edit</button>
                                <button onclick="window.deleteShift('${shift.id}')" class="text-red-500 hover:text-red-700 font-semibold flex items-center gap-1 text-xs">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
            historyList.innerHTML = `<div class="card glass-card rounded-xl overflow-hidden">${shiftsHTML}</div>`;
            if (!document.getElementById('calendar-overlay').classList.contains('hidden')) renderCalendarView();
        }
        
        window.prepareEditShift = (shiftId) => { 
            const shiftToEdit = allShifts.find(s => s.id === shiftId); 
            if (!shiftToEdit) return; 
            
            editingShiftId = shiftId; 
            document.getElementById('shift-date').value = shiftToEdit.rawDate; 
            renderLoggerTeamTabs(); 
            selectTeam(shiftToEdit.team);
            selectShift(shiftToEdit.shift);
            
            setTimeout(() => { 
                const dutyLocation = document.getElementById('duty-location');
                const redeployInput = document.getElementById('redeploy-location-input');
                const relevantLocations = DUTY_LOCATIONS[shiftToEdit.team] || DUTY_LOCATIONS['Others'];
                
                let locationFound = false;
                let savedLocation = shiftToEdit.location; // Could be 'Training' (mixed) or 'TRAINING' (upper)

                // Check direct match
                if (relevantLocations.includes(savedLocation)) {
                    dutyLocation.value = savedLocation; 
                    redeployInput.classList.add('hidden');
                    locationFound = true;
                }
                // Check uppercase match (in case data is old but list is new)
                else if (relevantLocations.includes(savedLocation.toUpperCase())) {
                     dutyLocation.value = savedLocation.toUpperCase();
                     redeployInput.classList.add('hidden');
                     locationFound = true;
                }
                else if (savedLocation.startsWith('AdHoc_') && shiftToEdit.team === 'Others') {
                     const freeText = savedLocation.replace('AdHoc_', '');
                     dutyLocation.value = ADHOC_MARKER;
                     redeployInput.value = freeText;
                     redeployInput.classList.remove('hidden');
                     locationFound = true;
                } 
                else if (savedLocation.startsWith('Redeploy_') && shiftToEdit.team === 'Others') {
                     const freeText = savedLocation.replace('Redeploy_', '');
                     dutyLocation.value = REDEPLOY_MARKER;
                     redeployInput.value = freeText;
                     redeployInput.classList.remove('hidden');
                     locationFound = true;
                }
                else if (savedLocation.startsWith('Training_') && shiftToEdit.team === 'Others') {
                     const freeText = savedLocation.replace('Training_', '');
                     dutyLocation.value = TRAINING_MARKER;
                     redeployInput.value = freeText;
                     redeployInput.classList.remove('hidden');
                     locationFound = true;
                }
                
                if (!locationFound) {
                    dutyLocation.value = dutyLocation.options[0].value; 
                    redeployInput.classList.add('hidden');
                    showToast(`Location "${shiftToEdit.location}" not found. Defaulting to first option.`, true);
                }
                updateRedeployInputVisibility(); 
            }, 50); 
            
            document.getElementById('shift-hours').value = shiftToEdit.hours; 
            document.getElementById('is-ot').checked = shiftToEdit.isOT; 
            document.getElementById('logger-title').textContent = 'Edit Shift'; 
            document.getElementById('save-assignment-btn').textContent = 'Update Shift'; 
            toggleOverlay('logger-overlay'); 
        };

        window.deleteShift = async (shiftId) => { 
            if (!userId) return showToast('Sign in to delete.', true);
            try { 
                await deleteDoc(doc(db, `users/${userId}/shifts`, shiftId)); 
                showToast('Shift deleted.'); 
            } catch (error) { 
                console.error("Error deleting:", error); 
                showToast('Failed to delete.', true); 
            } 
        };

        function prepareNewShift(date, shiftType) {
            editingShiftId = null;
            document.getElementById('shift-form').reset();
            document.getElementById('redeploy-location-input').classList.add('hidden'); 
            document.getElementById('logger-title').textContent = 'Log a New Shift';
            document.getElementById('save-assignment-btn').textContent = 'Log Assignment';
            
            document.getElementById('shift-date').value = date || new Date().toISOString().split('T')[0];
            
            renderLoggerTeamTabs(); 
            
            let initialTeam = 'Others';
            if (userProfile.userLocationFilter === 'Sentry' && !document.getElementById('sentry-tab').classList.contains('hidden')) initialTeam = 'Sentry';
            else if (userProfile.userLocationFilter === 'Foyer' && !document.getElementById('foyer-tab').classList.contains('hidden')) initialTeam = 'Foyer';
            else if (userProfile.userLocationFilter === 'Both') initialTeam = 'Sentry';

            if (shiftType === 'OFF_DAY_OT') {
                selectTeam('Others');
                selectShift('Morning'); 
                setTimeout(() => { 
                    document.getElementById('duty-location').value = 'OT'; 
                    document.getElementById('is-ot').checked = true;
                    document.getElementById('shift-hours').value = 0; 
                    updateRedeployInputVisibility();
                }, 0);
            } else { 
                selectTeam(initialTeam); 
                selectShift(shiftType || 'Morning');
                document.getElementById('shift-hours').value = 12; 
                updateRedeployInputVisibility();
            }
            toggleOverlay('logger-overlay');
        }

        function renderLoggerTeamTabs() {
            const filter = userProfile.userLocationFilter;
            const sentryTab = document.getElementById('sentry-tab');
            const foyerTab = document.getElementById('foyer-tab');
            const othersTab = document.getElementById('others-tab');

            if (filter === 'Sentry') {
                sentryTab.classList.remove('hidden'); foyerTab.classList.add('hidden'); othersTab.classList.remove('hidden');
            } else if (filter === 'Foyer') {
                sentryTab.classList.add('hidden'); foyerTab.classList.remove('hidden'); othersTab.classList.remove('hidden');
            } else {
                sentryTab.classList.remove('hidden'); foyerTab.classList.remove('hidden'); othersTab.classList.remove('hidden');
            }
            
            if (selectedTeam === 'Sentry' && filter === 'Foyer') selectedTeam = 'Foyer';
            else if (selectedTeam === 'Foyer' && filter === 'Sentry') selectedTeam = 'Sentry';
            else if (filter === 'Sentry' || filter === 'Both') { if(selectedTeam !== 'Others') selectedTeam = 'Sentry'; }
            else if (filter === 'Foyer') { if(selectedTeam !== 'Others') selectedTeam = 'Foyer'; }
        }

        async function saveAssignment() {
            const dateValue = document.getElementById('shift-date').value;
            const dutyLocationSelect = document.getElementById('duty-location');
            const redeployInput = document.getElementById('redeploy-location-input');
            
            if (!dateValue || !selectedShift) return showToast('Select date and shift.', true); 
            if (!userId) return showToast('Sign in required.', true); 
            
            let finalLocation = dutyLocationSelect.value;
            
            if (finalLocation === REDEPLOY_MARKER) {
                const freeText = redeployInput.value.trim();
                if (!freeText) return showToast('Enter Redeploy details.', true);
                finalLocation = `Redeploy_${freeText}`; 
            } else if (finalLocation === ADHOC_MARKER) {
                const freeText = redeployInput.value.trim();
                if (!freeText) return showToast('Enter AdHoc details.', true);
                finalLocation = `AdHoc_${freeText}`; 
            } else if (finalLocation === TRAINING_MARKER) {
                const freeText = redeployInput.value.trim();
                if (!freeText) return showToast('Enter Training details.', true);
                finalLocation = `Training_${freeText}`;
            }

            const hours = parseFloat(document.getElementById('shift-hours').value);
            const isOT = document.getElementById('is-ot').checked;
            if (isNaN(hours)) return showToast('Invalid hours.', true);
            
            const shiftData = { 
                rawDate: dateValue, 
                shiftTime: selectedShift === 'Morning' ? '08:00' : '20:00',
                shift: selectedShift,
                team: selectedTeam,
                location: finalLocation, // Saved as uppercase if selected from list
                hours: hours, 
                isOT: isOT 
            };

            if (finalLocation === OFF_DAY_MARKER) {
                shiftData.hours = 0; shiftData.isOT = false;
            } else if (finalLocation === 'AL' || finalLocation === 'MC') {
                shiftData.hours = 12; shiftData.isOT = false;
            }

            try { 
                if (editingShiftId) { 
                    await updateDoc(doc(db, `users/${userId}/shifts`, editingShiftId), shiftData); 
                    showToast('Shift updated!'); 
                } else { 
                    await addDoc(collection(db, `users/${userId}/shifts`), shiftData); 
                    showToast('Assignment logged!'); 
                } 
                toggleOverlay('logger-overlay'); 
            } catch (error) { 
                console.error("Error saving:", error); 
                showToast('Failed to save.', true); 
            } 
        }

        function selectShift(shift) { selectedShift = shift; const [morningBtn, nightBtn] = [document.getElementById('morning-shift-btn'), document.getElementById('night-shift-btn')]; morningBtn.classList.toggle('bg-white', shift === 'Morning'); morningBtn.classList.toggle('text-blue-700', shift === 'Morning'); nightBtn.classList.toggle('bg-white', shift === 'Night'); nightBtn.classList.toggle('text-blue-700', shift === 'Night'); }
        
        function selectTeam(team) {
            selectedTeam = team;
            ['sentry', 'foyer', 'others'].forEach(t => {
                const tab = document.getElementById(`${t}-tab`);
                if (tab) tab.classList.toggle('active', t === team.toLowerCase());
            });
            updateDutyLocationDropdown();
            updateRedeployInputVisibility();
        }

        function updateRedeployInputVisibility() {
            const dutyLocationSelect = document.getElementById('duty-location');
            const redeployInput = document.getElementById('redeploy-location-input');
            const selectedValue = dutyLocationSelect.value;
            
            if ((selectedValue === REDEPLOY_MARKER || selectedValue === ADHOC_MARKER || selectedValue === TRAINING_MARKER) && selectedTeam === 'Others') {
                redeployInput.classList.remove('hidden');
                if (selectedValue === REDEPLOY_MARKER) redeployInput.placeholder = "ENTER REDEPLOY LOCATION (E.G., BLOCK 12)";
                else if (selectedValue === ADHOC_MARKER) redeployInput.placeholder = "ENTER ADHOC DETAILS (E.G., EVENT GUARD)";
                else if (selectedValue === TRAINING_MARKER) redeployInput.placeholder = "ENTER TRAINING DETAILS (E.G., FIRE SAFETY)";
                redeployInput.focus();
            } else {
                redeployInput.classList.add('hidden');
                redeployInput.value = ''; 
            }
        }

        function updateDutyLocationDropdown() { 
            const dropdown = document.getElementById('duty-location'); 
            dropdown.innerHTML = ''; 
            const relevantLocations = DUTY_LOCATIONS[selectedTeam] || DUTY_LOCATIONS['Others'];
            relevantLocations.forEach(loc => { 
                const option = new Option(loc, loc); 
                // Ensure display text is uppercase (value is already uppercase from const)
                option.textContent = loc.toUpperCase(); 
                dropdown.appendChild(option); 
            }); 
        }

        function showToast(message, isError = false) { const toast = document.getElementById('toast'); toast.textContent = message; toast.className = `fixed bottom-24 right-5 text-white py-3 px-6 rounded-lg shadow-lg opacity-0 transform translate-y-10 transition-all duration-300 z-50 ${isError ? 'bg-red-500' : 'bg-green-500'}`; toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateY(10px)'; }, 3000); }
        
        async function handleClearHistory() { 
            if (!isAdmin) return showToast('Admin only.', true);
            const clearBtn = document.getElementById('clear-history-btn'); 
            if (clearBtn.dataset.confirming) { 
                clearTimeout(clearConfirmationTimeout); 
                if (!userId) return showToast('Auth error.', true); 
                try { 
                    const querySnapshot = await getDocs(collection(db, `users/${userId}/shifts`)); 
                    const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref)); 
                    await Promise.all(deletePromises); 
                    showToast('History cleared.'); 
                    resetClearButton(); 
                    toggleOverlay('tools-overlay'); 
                } catch (error) { 
                    console.error("Error clearing:", error);
                    showToast('Failed to clear.', true); 
                } 
            } else { 
                clearBtn.dataset.confirming = 'true'; 
                clearBtn.textContent = 'Confirm Clear?'; 
                clearBtn.classList.replace('bg-red-600', 'bg-yellow-500'); 
                clearBtn.classList.replace('hover:bg-red-700', 'hover:bg-yellow-600'); 
                clearConfirmationTimeout = setTimeout(resetClearButton, 3500); 
            } 
        }

        function resetClearButton() { const clearBtn = document.getElementById('clear-history-btn'); clearBtn.dataset.confirming = ''; clearBtn.textContent = 'Clear History'; clearBtn.classList.replace('bg-yellow-500', 'bg-red-600'); clearBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700'); }
        
        function openReportGenerator() {
            toggleOverlay('tools-overlay'); 
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
            document.getElementById('start-date-input').value = firstDayOfMonth;
            document.getElementById('end-date-input').value = lastDayOfMonth;
            toggleOverlay('report-generator-overlay');
        }

        function generateCustomReport() {
            const startDateString = document.getElementById('start-date-input').value;
            const endDateString = document.getElementById('end-date-input').value;
            if (!startDateString || !endDateString) return showToast('Select start and end dates.', true);

            const startDate = new Date(startDateString + 'T00:00:00');
            const endDate = new Date(endDateString + 'T23:59:59'); 
            if (startDate > endDate) return showToast('Start Date cannot be after End Date.', true);

            toggleOverlay('report-generator-overlay');
            _generateReportHTML(startDate, endDate);
        }

        function _generateReportHTML(startDate, endDate) {
            // Function to generate table rows. Includes logic to avoid duplicates.
            const createTeamBreakdown = (teamLocations, shiftList) => {
                const allReportedLocations = new Set();
                const countsMap = new Map();
                teamLocations.forEach(loc => countsMap.set(loc, { morning: 0, night: 0 }));

                shiftList.forEach(shift => {
                    let locKey = shift.location;
                    if(countsMap.has(locKey.toUpperCase())) locKey = locKey.toUpperCase();

                    // Logic to avoid re-adding "Others" locations if they are not in the current team list
                    // Basically, if a shift location isn't in predefined teamLocations, we check if we should add it.
                    if (!countsMap.has(locKey)) {
                         // Only add dynamic locations if they belong to the current filtered view.
                         // But since we pre-filtered 'shiftList' passed to this function, we can trust the shifts here.
                         allReportedLocations.add(locKey);
                         countsMap.set(locKey, { morning: 0, night: 0 });
                    }
                    
                    const counts = countsMap.get(locKey);
                    if (counts) {
                        if (shift.shift === 'Morning') counts.morning += 1;
                        else if (shift.shift === 'Night') counts.night += 1;
                    }
                });
                
                const markersToRemove = [REDEPLOY_MARKER, ADHOC_MARKER, TRAINING_MARKER, 'OT'];
                const locationsToReport = Array.from(new Set([...teamLocations, ...Array.from(allReportedLocations)]))
                    .filter(loc => !markersToRemove.includes(loc))
                    .sort((a, b) => a.localeCompare(b));

                return locationsToReport.map(loc => {
                    const counts = countsMap.get(loc) || { morning: 0, night: 0 };
                    const isPrefixedFreeText = loc.startsWith('AdHoc_') || loc.startsWith('Redeploy_') || loc.startsWith('Training_');
                    let colorKey = loc;
                    if(isPrefixedFreeText) {
                        if (loc.startsWith('AdHoc_')) colorKey = ADHOC_MARKER;
                        else if (loc.startsWith('Redeploy_')) colorKey = REDEPLOY_MARKER;
                        else if (loc.startsWith('Training_')) colorKey = TRAINING_MARKER;
                    }
                    
                    const colorInfo = LOCATION_COLORS[colorKey] || LOCATION_COLORS[colorKey.toUpperCase()] || { bg: 'bg-gray-100', text: 'text-gray-800' };
                    const displayLoc = loc.replace('AdHoc_', 'ADHOC: ').replace('Redeploy_', 'REDEPLOY: ').replace('Training_', 'TRAINING: ').toUpperCase();
                    const totalShifts = counts.morning + counts.night;

                    return `<tr>
                            <td style="padding: 8px; background-color:${colorInfo.bg}; border-radius: 4px;">${displayLoc}</td>
                            <td style="padding: 8px; text-align: center;">${counts.morning}</td>
                            <td style="padding: 8px; text-align: center;">${counts.night}</td>
                            <td style="padding: 8px; text-align: center; font-weight: bold;">${totalShifts}</td>
                        </tr>`;
                }).join('');
            };

            const rawShifts = allShifts.filter(s => isTeamRelevant(s.team));
            let shiftsForReport = rawShifts.filter(s => {
                const shiftDate = new Date(s.rawDate + 'T00:00:00');
                return shiftDate >= startDate && shiftDate <= endDate;
            });
            
            if (shiftsForReport.length === 0) return showToast('No data to report.', true); 
            
            shiftsForReport.sort((a, b) => new Date(a.rawDate) - new Date(b.rawDate));
            
            let totalHours = 0, totalMorningHours = 0, totalNightHours = 0, totalOTShifts = 0, totalMorningOTShifts = 0, totalNightOTShifts = 0;  
            shiftsForReport.forEach(s => { 
                totalHours += s.hours; 
                if (s.isOT) {
                    totalOTShifts++; 
                    if (s.shift === 'Morning') totalMorningOTShifts++;
                    if (s.shift === 'Night') totalNightOTShifts++;
                }
                if (s.shift === 'Morning') totalMorningHours += s.hours;
                if (s.shift === 'Night') totalNightHours += s.hours;
            });

            const otHoursSummary = Math.max(0, totalHours - CONTRACTUAL_HOURS);
            const startDisplay = startDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric', day: 'numeric' });
            const endDisplay = endDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric', day: 'numeric' });
            const dateRangeTitle = startDate.toDateString() === endDate.toDateString() ? startDisplay : `${startDisplay} to ${endDisplay}`;

            const userMetadataHTML = `<div style="margin-bottom: 1.5em; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
                    <p style="margin: 0 0 5px 0; font-size: 1.1em; font-weight: 600;">Report For:</p>
                    <ul style="list-style: none; padding: 0; font-size: 0.95em;">
                        <li><strong>Name:</strong> ${userProfile.userName || 'N/A'}</li>
                        <li><strong>Employee ID:</strong> ${userProfile.employeeId || 'N/A'}</li>
                        <li><strong>Email:</strong> ${auth.currentUser?.email || 'N/A'}</li>
                    </ul>
                </div>`;

            // NEW: Professional Summary Card HTML
            const summaryHTML = `
                <h3>Summary</h3>
                <div style="display: flex; gap: 15px; margin-bottom: 2em;">
                    <div style="flex: 1; padding: 15px; background: #eff6ff; border-radius: 8px; border: 1px solid #dbeafe; text-align: center;">
                        <div style="font-size: 0.9em; color: #1e40af; font-weight: 600; text-transform: uppercase;">Planned Hours</div>
                        <div style="font-size: 1.8em; font-weight: 800; color: #1e3a8a; margin-top: 5px;">${CONTRACTUAL_HOURS}</div>
                    </div>
                    <div style="flex: 1; padding: 15px; background: #eef2ff; border-radius: 8px; border: 1px solid #e0e7ff; text-align: center;">
                        <div style="font-size: 0.9em; color: #3730a3; font-weight: 600; text-transform: uppercase;">Total Logged</div>
                        <div style="font-size: 1.8em; font-weight: 800; color: #312e81; margin-top: 5px;">${totalHours}</div>
                    </div>
                    <div style="flex: 1; padding: 15px; background: #fffbeb; border-radius: 8px; border: 1px solid #fde68a; text-align: center;">
                        <div style="font-size: 0.9em; color: #92400e; font-weight: 600; text-transform: uppercase;">Overtime</div>
                        <div style="font-size: 1.8em; font-weight: 800; color: #b45309; margin-top: 5px;">${otHoursSummary}</div>
                    </div>
                </div>
            `;

            let sentryTableHTML = '';
            if (userProfile.userLocationFilter === 'Sentry' || userProfile.userLocationFilter === 'Both') {
                const relevant = shiftsForReport.filter(s => s.team === 'Sentry' || s.team === 'Others'); 
                const breakdown = [...DUTY_LOCATIONS.Sentry, ...DUTY_LOCATIONS.Others];
                sentryTableHTML = `<h3>Sentry & Other Duties Frequency</h3><table><thead><tr><th style="width: 40%;">Location / Duty</th><th style="width: 20%;">Morning</th><th style="width: 20%;">Night</th><th style="width: 20%;">Total</th></tr></thead><tbody>${createTeamBreakdown(breakdown, relevant)}</tbody></table>`;
            }

            let foyerTableHTML = '';
            if (userProfile.userLocationFilter === 'Foyer' || userProfile.userLocationFilter === 'Both') {
                const isBoth = userProfile.userLocationFilter === 'Both';
                const relevant = shiftsForReport.filter(s => s.team === 'Foyer' || (!isBoth && s.team === 'Others'));
                const breakdown = isBoth ? [...DUTY_LOCATIONS.Foyer] : [...DUTY_LOCATIONS.Foyer, ...DUTY_LOCATIONS.Others];
                foyerTableHTML = `<h3>Foyer ${!isBoth ? '& Other ' : ''}Duties Frequency</h3><table><thead><tr><th style="width: 40%;">Location / Duty</th><th style="width: 20%;">Morning</th><th style="width: 20%;">Night</th><th style="width: 20%;">Total</th></tr></thead><tbody>${createTeamBreakdown(breakdown, relevant)}</tbody></table>`;
            }

            const otBreakdownHTML = `
                <h3 style="margin-top: 2em;">Overtime Shift Breakdown (Count)</h3>
                <table><thead><tr><th style="width: 50%;">Shift Type (Flagged OT)</th><th style="width: 50%;">Shift Count</th></tr></thead><tbody>
                    <tr><td style="padding: 8px;">Morning OT Shifts</td><td style="padding: 8px; text-align: center;">${totalMorningOTShifts}</td></tr>
                    <tr><td style="padding: 8px;">Night OT Shifts</td><td style="padding: 8px; text-align: center;">${totalNightOTShifts}</td></tr>
                    <tr style="font-weight: 700; background-color: #fef3c7;"><td style="padding: 8px;">TOTAL OT SHIFTS LOGGED:</td><td style="padding: 8px; text-align: center;">${totalOTShifts}</td></tr>
                </tbody></table>
            `;
            
            const detailedLogBody = shiftsForReport.map(s => {
                const isOTMark = s.isOT ? `<span style="color:#f59e0b; font-weight:700;">(OT)</span>` : '';
                let displayLocation = s.location;
                let colorKey = s.location;
                if (s.location.startsWith('AdHoc_')) { displayLocation = `ADHOC: ${s.location.replace('AdHoc_', '')}`; colorKey = ADHOC_MARKER; }
                else if (s.location.startsWith('Redeploy_')) { displayLocation = `REDEPLOY: ${s.location.replace('Redeploy_', '')}`; colorKey = REDEPLOY_MARKER; }
                else if (s.location.startsWith('Training_')) { displayLocation = `TRAINING: ${s.location.replace('Training_', '')}`; colorKey = TRAINING_MARKER; }
                
                const colorInfo = LOCATION_COLORS[colorKey] || LOCATION_COLORS[colorKey.toUpperCase()] || { hex: '#ffffff' };
                return `<tr style="border-left: 5px solid ${colorInfo.hex};"><td style="padding: 8px;">${new Date(s.rawDate+'T00:00:00').toLocaleDateString('en-GB')}</td><td style="padding: 8px; font-weight: 600;">${s.shift}</td><td style="padding: 8px;">${displayLocation.toUpperCase()}</td><td style="padding: 8px; text-align: center;">${s.hours} ${isOTMark}</td></tr>`;
            }).join('');
            
            const reportHTML = `<html><head><title>Shift Report - ${dateRangeTitle}</title><style>body{font-family:sans-serif;margin:2em;}h1,h2{text-align:center;color:#333}h3{margin-top:1.5em;color:#555;}ul{list-style:none;padding:0;}ul li{margin-bottom:0.5em;font-size:1.1em;}table{width:100%;border-collapse:collapse;margin-top:1em;margin-bottom:2em}th,td{border:1px solid #ddd;padding:10px;text-align:left;font-size:0.95em;}th{background-color:#e5e7eb;font-weight:600;text-align:center;}th:first-child, td:first-child { text-align: left; }tr:nth-child(even) td{background-color:#f9fafb;}</style></head><body><h1>Shift Report</h1><h2>${dateRangeTitle}</h2>${userMetadataHTML}${summaryHTML}${sentryTableHTML}${foyerTableHTML}${otBreakdownHTML}<h3>Detailed Log</h3><table><thead><tr><th>Date</th><th>Shift</th><th>Location</th><th style="text-align: center; width: 15%;">Hours</th></tr></thead><tbody>${detailedLogBody}</tbody></table></body></html>`;
            
            const blob = new Blob([reportHTML], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
        }

        function getActiveTeamPattern() { return allTeams.find(t => t.id === userProfile.userTeamId); }
        function getAutoShiftForDay(day, year, month, teamPattern) {
            if (!teamPattern || !teamPattern.anchor || !teamPattern.pattern || teamPattern.pattern.length === 0) return null;
            const diffDays = Math.round((new Date(year, month, day) - new Date(teamPattern.anchor + 'T00:00:00')) / (1000 * 60 * 60 * 24));
            const pattern = teamPattern.pattern;
            return { type: pattern[(diffDays % pattern.length + pattern.length) % pattern.length].type, isAuto: true };
        }

        function renderTeamManagerList() {
            const container = document.getElementById('team-manager-content');
            container.innerHTML = `
                <div class="p-6 space-y-4">
                    <div class="flex justify-between items-center pb-2 border-b border-white/20">
                        <h2 class="text-lg font-semibold text-gray-700">${isAdmin ? 'All Teams' : 'Select Your Roster Team'}</h2>
                        <button id="add-new-team-btn" class="btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg text-sm z-50">Add New Team</button>
                    </div>
                    <div id="teams-list" class="space-y-3"><p id="no-teams-message" class="text-center text-gray-500 py-4 hidden">No teams created.</p></div>
                </div>`;
            document.getElementById('add-new-team-btn').addEventListener('click', () => openEditTeamPattern(null));
            
            const listContainer = document.getElementById('teams-list');
            if (allTeams.length === 0) document.getElementById('no-teams-message').classList.remove('hidden');
            
            allTeams.forEach(team => {
                const isActive = team.id === userProfile.userTeamId;
                const patternSummary = team.pattern?.map(p => p.type).join(', ') || 'No pattern';
                const teamItem = document.createElement('div');
                teamItem.className = `glass-card p-4 rounded-xl flex flex-col sm:flex-row justify-between items-start sm:items-center ${isActive ? 'border-2 border-indigo-600' : 'border border-white/20'}`;
                
                let actionButton = isActive ? `<span class="text-sm text-gray-500 py-2 px-3 font-medium">Selected</span>` : `<button onclick="window.setUserTeam('${team.id}')" class="text-sm bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 rounded-lg">Select</button>`;
                if (isAdmin) actionButton = `<button onclick="window.openEditTeamPattern('${team.id}')" class="text-sm text-blue-500 hover:text-blue-700 font-semibold p-2 bg-white/50 rounded-lg">Edit</button> ${actionButton} ${!isActive ? `<button onclick="window.deleteTeam('${team.id}')" class="text-sm text-red-500 hover:text-red-700 font-semibold p-2 bg-white/50 rounded-lg">Delete</button>` : ''}`;

                teamItem.innerHTML = `<div class="flex-grow w-full"><div class="flex items-center gap-2"><h3 class="text-lg font-bold text-gray-800 truncate">${team.teamName}</h3>${isActive ? '<span class="text-xs font-semibold bg-indigo-100 text-indigo-700 py-0.5 px-2 rounded-full">ACTIVE</span>' : ''}</div><p class="text-sm text-gray-600 mt-1 truncate">Pattern: ${patternSummary}</p></div><div class="flex space-x-2 mt-3 sm:mt-0 flex-shrink-0">${actionButton}</div>`;
                listContainer.appendChild(teamItem);
            });
        }

        window.setUserTeam = async (teamId) => {
            if (!userId) return showToast('Sign in required.', true);
            try { await setDoc(doc(db, `users/${userId}/settings`, 'profile'), { userTeamId: teamId }, { merge: true }); showToast(`Active team set!`); }
            catch(e) { console.error(e); showToast('Failed to set team.', true); }
        };
        
        window.deleteTeam = async (teamId) => {
            if (!userId) return showToast('Sign in required.', true);
            if (teamId === userProfile.userTeamId) return showToast('Cannot delete active team.', true);
            try { await deleteDoc(doc(db, `users/${userId}/teams`, teamId)); showToast('Team deleted.'); }
            catch (e) { console.error(e); showToast('Failed to delete team.', true); }
        };

        function openTeamManager() {
            renderTeamManagerList();
            toggleOverlay('team-manager-overlay');
            toggleOverlay('tools-overlay');
        }

        window.openEditTeamPattern = (teamId) => {
            if (!userId) return showToast('Sign in required.', true);
            const teamToEdit = teamId ? allTeams.find(t => t.id === teamId) : null;
            if (teamId && !teamToEdit) return showToast('Team not found!', true);
            
            editingTeam = teamToEdit ? JSON.parse(JSON.stringify(teamToEdit)) : { id: null, teamName: 'New Team', anchor: new Date().toISOString().split('T')[0], patternLength: 6, pattern: Array(6).fill({ type: 'OFF' }) };
            document.getElementById('edit-team-title').textContent = teamToEdit ? `Edit: ${teamToEdit.teamName}` : `Create New Team`;
            document.getElementById('team-name-input').value = editingTeam.teamName;
            document.getElementById('pattern-anchor-date').value = editingTeam.anchor;
            document.getElementById('pattern-length').value = editingTeam.patternLength;
            renderPatternGrid();
            toggleOverlay('edit-team-pattern-overlay');
            if(!document.getElementById('team-manager-overlay').classList.contains('hidden')) toggleOverlay('team-manager-overlay');
            if(!document.getElementById('tools-overlay').classList.contains('hidden')) toggleOverlay('tools-overlay');
        };

        function renderPatternGrid() {
            const grid = document.getElementById('visual-pattern-grid');
            const pattern = editingTeam.pattern;
            grid.innerHTML = '';
            const length = pattern.length;
            grid.className = `grid gap-3 ${length > 6 ? 'md:grid-cols-6' : (length > 4 ? 'sm:grid-cols-4' : 'grid-cols-3')}`;

            pattern.forEach((shift, index) => {
                const shiftType = shift.type || 'OFF';
                let value = shiftType === 'M' ? 'MORNING' : (shiftType === 'N' ? 'NIGHT' : shiftType);
                const cell = document.createElement('div');
                cell.className = `pattern-cell rounded-lg pattern-cell-${shiftType}`;
                cell.dataset.index = index;
                cell.innerHTML = `<span class="pattern-label">Day ${index + 1}</span><span class="pattern-value">${value}</span>`;
                grid.appendChild(cell);
            });
        }
        
        function handlePatternCellClick(event) {
            const cell = event.target.closest('.pattern-cell');
            if (!cell) return;
            const index = parseInt(cell.dataset.index);
            const nextType = SHIFT_TYPES[(SHIFT_TYPES.indexOf(editingTeam.pattern[index].type) + 1) % SHIFT_TYPES.length];
            editingTeam.pattern[index] = { type: nextType };
            renderPatternGrid();
        }

        function handlePatternLengthChange(event) {
            let newLength = parseInt(event.target.value);
            if (isNaN(newLength) || newLength < 1) newLength = 1;
            if (newLength > 30) newLength = 30;
            const oldLength = editingTeam.pattern.length;
            if (newLength === oldLength) return;
            
            const newPattern = [];
            for (let i = 0; i < newLength; i++) newPattern.push(i < oldLength ? editingTeam.pattern[i] : { type: 'OFF' });
            editingTeam.patternLength = newLength;
            editingTeam.pattern = newPattern;
            renderPatternGrid();
        }

        async function saveTeamPattern() {
            if (!userId) return showToast('Sign in required.', true);
            const teamName = document.getElementById('team-name-input').value.trim();
            const anchor = document.getElementById('pattern-anchor-date').value;
            const patternLength = parseInt(document.getElementById('pattern-length').value);
            const pattern = editingTeam.pattern.slice(0, patternLength); 
            if (!teamName || !anchor || patternLength < 1) return showToast('Invalid input.', true);

            const teamData = { teamName, anchor, patternLength, pattern };
            try {
                if (editingTeam.id) await updateDoc(doc(db, `users/${userId}/teams`, editingTeam.id), teamData);
                else await addDoc(collection(db, `users/${userId}/teams`), teamData);
                showToast(`Team saved!`);
                toggleOverlay('edit-team-pattern-overlay');
                openTeamManager();
            } catch (error) { console.error(error); showToast('Failed to save.', true); }
        }

        function openCalendarView() { renderCalendarView(); toggleOverlay('calendar-overlay'); }

        function renderCalendarView() {
            const calendarGrid = document.getElementById('calendar-grid');
            const weekdaysGrid = document.getElementById('calendar-weekdays');
            if (!calendarGrid) return;
            
            const activeTeamPattern = getActiveTeamPattern();
            const year = displayedDate.getFullYear();
            const month = displayedDate.getMonth();
            document.getElementById('calendar-title').textContent = displayedDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const filteredShifts = allShifts.filter(s => isTeamRelevant(s.team));
            const shiftsByDay = new Map();
            filteredShifts.filter(s => {
                const d = new Date(s.rawDate + 'T00:00:00');
                return d.getFullYear() === year && d.getMonth() === month;
            }).forEach(s => shiftsByDay.set(new Date(s.rawDate + 'T00:00:00').getDate(), s));

            calendarGrid.innerHTML = ''; weekdaysGrid.innerHTML = '';
            WEEKDAYS.forEach(d => weekdaysGrid.innerHTML += `<div class="text-center text-xs sm:text-sm font-bold text-gray-500 uppercase">${d}</div>`);
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) calendarGrid.innerHTML += `<div class="calendar-cell empty rounded-lg"></div>`;

            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell rounded-lg p-2 flex flex-col';
                const dayDate = new Date(year, month, day);
                const dayNumHTML = `<span class="day-num text-sm sm:text-base ${[0, 6].includes(dayDate.getDay()) ? 'weekend' : ''}">${day}</span>`;
                
                const loggedShift = shiftsByDay.get(day);
                const autoShift = getAutoShiftForDay(day, year, month, activeTeamPattern);
                
                if (loggedShift) {
                    // Try direct key, then upper key
                    let colorKey = loggedShift.location;
                    if(colorKey.startsWith('AdHoc_')) colorKey = ADHOC_MARKER;
                    else if(colorKey.startsWith('Redeploy_')) colorKey = REDEPLOY_MARKER;
                    else if(colorKey.startsWith('Training_')) colorKey = TRAINING_MARKER;
                    
                    const colorInfo = LOCATION_COLORS[colorKey] || LOCATION_COLORS[colorKey.toUpperCase()] || { bg: 'bg-gray-100', text: 'text-gray-800' };
                    let displayLocation = loggedShift.location;
                    if (displayLocation.startsWith('AdHoc_')) displayLocation = 'AdHoc: ' + displayLocation.replace('AdHoc_', '');
                    else if (displayLocation.startsWith('Redeploy_')) displayLocation = 'R/D: ' + displayLocation.replace('Redeploy_', '');
                    else if (displayLocation.startsWith('Training_')) displayLocation = 'TRN: ' + displayLocation.replace('Training_', '');
                    
                    displayLocation = displayLocation.length > 15 ? displayLocation.substring(0, 12) + '...' : displayLocation.replace(' (CNB DST)', ' N1').replace('OE / STANDBY', 'OE/SB');

                    const shiftIcon = loggedShift.shift === 'Morning' ? ICONS.morning : (loggedShift.shift === 'Night' ? ICONS.night : ICONS.others);
                    cell.className += ` shift-bg-${loggedShift.shift}`;
                    cell.innerHTML = `${dayNumHTML}<div class="logged-shift-card"><div class="flex flex-col items-center flex-grow"><span class="shift-icon">${shiftIcon}</span><span class="location-text">${displayLocation.toUpperCase()}</span></div><div class="mt-1 flex flex-col items-center w-full"><span class="hours-text">${loggedShift.hours}h</span>${loggedShift.isOT ? '<span class="ot-tag-cal">OT</span>' : ''}</div></div>`;
                    cell.onclick = () => { toggleOverlay('calendar-overlay'); window.prepareEditShift(loggedShift.id); };
                } else if (autoShift && activeTeamPattern && userProfile.userTeamId) {
                    const type = autoShift.type;
                    const shiftIcon = type === 'M' ? ICONS.morning : (type === 'N' ? ICONS.night : '');
                    const shiftColor = type === 'M' ? 'text-amber-500' : (type === 'N' ? 'text-indigo-700' : 'text-green-700');
                    const hours = type === 'OFF' ? '0h' : '12h';
                    cell.className += ` shift-bg-${type === 'M' ? 'Morning' : (type === 'N' ? 'Night' : 'OFF')}`;
                    cell.innerHTML = `${dayNumHTML}<div class="auto-shift-card"><span class="shift-icon" style="opacity: 0.6; color: ${shiftColor};">${shiftIcon}</span><span class="auto-shift-text" style="color: ${shiftColor};">${type}</span><span class="text-xs text-gray-500">${hours}</span></div>`;
                    cell.onclick = () => { toggleOverlay('calendar-overlay'); prepareNewShift(`${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`, type === 'N' ? 'Night' : (type === 'OFF' ? 'OFF_DAY_OT' : 'Morning')); };
                } else {
                    cell.classList.add('empty');
                    cell.innerHTML = dayNumHTML;
                }
                calendarGrid.appendChild(cell);
            }
        }

        // --- VALIDATION TOOL LOGIC (Updated with Preprocessing & Correct Column) ---
        
        
// Image upload handler for validation  expects a cropped image
// of the Deemed MTH column OR a full screenshot. It simply runs
// Tesseract once and drops the raw text into the textarea.
// NOTE: For best accuracy, crop the screenshot so it only
// contains the Deemed MTH column before uploading.
// Image upload handler for validation (no auto-crop, rely on OCR + smart parser)
// For best results, crop your screenshot around the "Deemed MTH" column before uploading.
function handleImageUpload(e) {
    var file = e.target.files[0];
    if (!file) return;

    var statusDiv  = document.getElementById('ocr-status');
    var textarea   = document.getElementById('validation-input');
    var analyzeBtn = document.getElementById('analyze-validation-btn');

    if (statusDiv) {
        statusDiv.classList.remove('hidden', 'text-green-600', 'text-red-600');
        statusDiv.classList.add('text-blue-600');
        statusDiv.textContent = 'Scanning image...';
    }

    if (textarea) {
        textarea.value = '';
        textarea.disabled = true;
    }
    if (analyzeBtn) {
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }

    Tesseract.recognize(file, 'eng', {
        logger: function (m) {
            if (!statusDiv) return;
            if (m.status === 'recognizing text' && typeof m.progress === 'number') {
                var pct = Math.round(m.progress * 100);
                statusDiv.textContent = 'Reading text from image... (' + pct + '%)';
            }
        }
    }).then(function (result) {
        var text = result && result.data && result.data.text ? result.data.text : '';
        if (textarea) {
            textarea.value = text;
            textarea.disabled = false;
        }
        if (analyzeBtn) {
            analyzeBtn.disabled = false;
            analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (statusDiv) {
            statusDiv.classList.remove('text-blue-600');
            statusDiv.classList.add('text-green-600');
            statusDiv.textContent = 'Scan complete! Please verify the text below, then click Analyze.';
        }
        if (textarea && textarea.scrollIntoView) {
            textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }).catch(function (err) {
        console.error('OCR error:', err);
        if (textarea) {
            textarea.value = '';
            textarea.disabled = false;
        }
        if (analyzeBtn) {
            analyzeBtn.disabled = false;
            analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (statusDiv) {
            statusDiv.classList.remove('text-blue-600');
            statusDiv.classList.add('text-red-600');
            statusDiv.textContent = 'Error scanning image. Please try again or use manual paste.';
        }
    });
}



function runValidationAnalysis() {
    var rawText = document.getElementById('validation-input').value || '';
    if (!rawText.trim()) {
        return showToast('Paste report data or upload an image first.', true);
    }

    // Quick sanity check: we expect at least one hour-like value such as 12.00 or 0.00.
    // If none are found, the OCR text is most likely just headers/noise, so we abort
    // instead of trying to guess from random integers.
    var hasHourPattern = /\d{1,2}[.,]\d{2}/.test(rawText);
    if (!hasHourPattern) {
        return showToast(
            'Could not find any hour values like 12.00 or 0.00 in the scanned text. ' +
            'Please crop the image closer to the Deemed MTH column or paste the report text.',
            true
        );
    }

    // Remove obvious header words if OCR picked them up
    rawText = rawText.replace(/Deemed/gi, ' ').replace(/MTH/gi, ' ');

    var rawLines = rawText
        .split(/\r?\n/)
        .map(function (l) { return l.trim(); })
        .filter(function (l) { return l.length > 0; });

    // Skip leading header lines (no digits) BEFORE the first numeric line
    var lines = [];
    var seenNumeric = false;

    rawLines.forEach(function (line) {
        var hasDigit = /\d/.test(line);
        if (!seenNumeric) {
            if (!hasDigit) {
                // still in header area  ignore this line
                return;
            }
            // first numeric line  day 1 starts here
            seenNumeric = true;
        }
        lines.push(line);
    });

    if (!lines.length) {
        return showToast(
            'After removing headers, no usable hour values were found. ' +
            'Please try a clearer image or paste the report text.',
            true
        );
    }

    // Now parse one value per line/day with smart OCR fixes
    var extracted = [];

    lines.forEach(function (line, idx) {
        var value = null;
        var m;

        // 1) Ideal: 12.00 / 0.00 / 11.50 etc.
        m = line.match(/\d{1,2}[.,]\d{2}/);
        if (m) {
            value = parseFloat(m[0].replace(',', '.'));
        } else {
            // 2) OCR dropped the dot: 1200, 1100  12.00, 11.00
            m = line.match(/\d{3,4}/);
            if (m) {
                var n = parseInt(m[0], 10);
                if (!isNaN(n) && n % 100 === 0) {
                    var candidate = n / 100;
                    if (candidate >= 0 && candidate <= 23) {
                        value = candidate;
                    }
                }
            }
        }

        // We deliberately DO NOT fall back to "any 023 integer" here, because
        // when OCR is very noisy (like "8 nas 2 ous"), those digits are not
        // reliable hour values and will corrupt the alignment.

        var ocrError = false;
        if (value === null || isNaN(value)) {
            // Unreadable line in the BODY  keep alignment, treat as 0.00,
            // but mark as OCR error so the user can re-check that day.
            value = 0;
            ocrError = true;
        }

        extracted.push({
            value: Math.round(value),
            ocrError: ocrError,
            lineIndex: idx + 1
        });
    });

    var year = displayedDate.getFullYear();
    var month = displayedDate.getMonth(); // 0-based
    var daysInMonth = new Date(year, month + 1, 0).getDate();

    var reportDataCol = [];
    var problemDays = [];

    for (var day = 1; day <= daysInMonth; day++) {
        var dd = String(day).padStart(2, '0');
        var mm = String(month + 1).padStart(2, '0');
        var yyyy = String(year);

        var iso = yyyy + '-' + mm + '-' + dd;
        var display = dd + '-' + mm + '-' + yyyy;

        var info = extracted[day - 1];
        var sysH = 0;

        if (info) {
            sysH = info.value;
            if (info.ocrError) {
                problemDays.push(day);
            }
        } else {
            // fewer OCR lines than days  treat missing days as 0.00 and warn
            sysH = 0;
            problemDays.push(day);
        }

        reportDataCol.push({
            date: iso,
            systemHours: sysH,
            originalDate: display
        });
    }

    if (problemDays.length) {
        showToast(
            'OCR could not confidently read system hours for day(s): ' +
            problemDays.join(', ') +
            '. These were treated as 0.00  please double-check them.',
            true
        );
    }

    return renderValidationResults(reportDataCol);
}

function renderValidationResults(reportData) {
    var listEl = document.getElementById('validation-list');
    var resultsDiv = document.getElementById('validation-results');
    listEl.innerHTML = '';

    var totalApp = 0;
    var totalSystem = 0;

    reportData.forEach(function (row) {
        var appShift = allShifts.find(function (s) {
            return s.rawDate === row.date;
        });

        var div = document.createElement('div');
        div.className = 'validation-row';

        var appHours = appShift ? appShift.hours : 0;

        // Determine status text and style
        var statusText = 'OFF';
        var statusClass = 'text-gray-400';

        if (appShift && appHours > 0 && row.systemHours > 0) {
            if (Math.round(appHours) === Math.round(row.systemHours)) {
                statusText = 'MATCH';
                statusClass = 'val-match';
            } else {
                statusText = 'MISMATCH';
                statusClass = 'val-mismatch';
            }
        } else if (appShift && appHours > 0 && row.systemHours === 0) {
            statusText = 'EXTRA LOG';
            statusClass = 'val-mismatch';
        } else if ((!appShift || appHours === 0) && row.systemHours > 0) {
            statusText = 'MISSING LOG';
            statusClass = 'val-mismatch';
        }

        totalApp += appHours;
        totalSystem += row.systemHours;

        div.innerHTML = ''
            + '<div>' + row.originalDate + '</div>'
            + '<div class="' + (appShift ? '' : 'text-gray-400') + '">' + appHours.toFixed(2) + '</div>'
            + '<div>' + row.systemHours.toFixed(2) + '</div>'
            + '<div class="' + statusClass + '">' + statusText + '</div>';

        listEl.appendChild(div);
    });

    // Summary row
    var summaryDiv = document.createElement('div');
    summaryDiv.className = 'validation-row bg-indigo-50 font-semibold';

    var diff = totalApp - totalSystem;
    var diffLabel;
    var diffClass;

    if (Math.abs(diff) < 0.01) {
        diffLabel = 'BALANCED';
        diffClass = 'val-match';
    } else if (diff > 0) {
        diffLabel = '+' + diff.toFixed(2) + ' (App more)';
        diffClass = 'val-mismatch';
    } else {
        diffLabel = diff.toFixed(2) + ' (System more)';
        diffClass = 'val-mismatch';
    }

    summaryDiv.innerHTML = ''
        + '<div>Total</div>'
        + '<div>' + totalApp.toFixed(2) + '</div>'
        + '<div>' + totalSystem.toFixed(2) + '</div>'
        + '<div class="' + diffClass + '">' + diffLabel + '</div>';

    listEl.appendChild(summaryDiv);

    resultsDiv.classList.remove('hidden');
    showToast('Analysis Complete.');
}



// === Excel Upload -> Validation Text Bridge (CSV-FOCUSED, NO XLSX NEEDED) ===
// Mobile-friendly approach for RptAttendanceFlexible CSV export or simplified CSV.
// We read the uploaded file as TEXT. If it looks like a CSV, we parse it and
// try to locate one of these header pairs:
//   1) txtTblDaily_ClockDate_1 + txtTblDaily_TE40_24
//   2) Date + DEEME D MTH
// We then build simple lines: DD-MM-YYYY\tHH.hh fed into the validator.
//
// If the file does not look like CSV (e.g. true binary .xls), we fall back
// to putting the raw text into the textarea and let the user decide.
(function () {
    var excelInput = document.getElementById('excel-upload');
    if (!excelInput) return;

    excelInput.addEventListener('change', function (evt) {
        var file = evt.target.files && evt.target.files[0];
        var statusEl = document.getElementById('excel-status');
        var textarea = document.getElementById('validation-input');
        var analyzeBtn = document.getElementById('analyze-validation-btn');

        function enableAnalyze() {
            if (analyzeBtn) {
                analyzeBtn.disabled = false;
                analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function disableAnalyze() {
            if (analyzeBtn) {
                analyzeBtn.disabled = true;
                analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // If user clears the file input
        if (!file) {
            if (statusEl) {
                statusEl.textContent = '';
                statusEl.classList.add('hidden');
            }
            if (textarea) {
                textarea.disabled = false;
            }
            enableAnalyze();
            return;
        }

        if (statusEl) {
            statusEl.textContent = 'Reading report file...';
            statusEl.classList.remove('hidden', 'text-red-600');
            statusEl.classList.add('text-green-700');
        }

        if (textarea) {
            textarea.value = '';
            textarea.disabled = true;
        }
        disableAnalyze();

        var reader = new FileReader();

        reader.onload = function (e) {
            try {
                var text = e.target.result || '';

                // Detect binary / gibberish (typical for true .XLS)
                var printable = text.replace(/[\x20-\x7E\r\n\t]/g, '');
                if (printable.length > 0 && printable.length / text.length > 0.3) {
                    // Too many non-printable chars  likely binary Excel
                    if (textarea) {
                        textarea.value = '';
                        textarea.disabled = false;
                    }

                    if (statusEl) {
                        statusEl.textContent = 'This file looks like a binary Excel (.xls). Please open in Excel and "Save As CSV", then upload the CSV.';
                        statusEl.classList.remove('text-green-700');
                        statusEl.classList.add('text-red-600');
                        statusEl.classList.remove('hidden');
                    }

                    enableAnalyze();
                    if (typeof showToast === 'function') {
                        showToast('File looks like binary Excel. Please export as CSV and re-upload, or paste the text manually.', true);
                    }
                    return;
                }

                // Simple CSV detection: first line contains commas
                var firstLineEnd = text.indexOf('\n');
                if (firstLineEnd === -1) firstLineEnd = text.length;
                var headerLine = text.slice(0, firstLineEnd).trim();

                var isCsvLike = headerLine.indexOf(',') !== -1;

                if (isCsvLike) {
                    var lines = text.split(/\r?\n/).filter(function (ln) { return ln.trim() !== ''; });
                    if (lines.length <= 1) {
                        throw new Error('CSV appears to have no data rows.');
                    }

                    // Parse header, trimming quotes and spaces
                    var rawHeaders = lines[0].split(',');
                    var headers = rawHeaders.map(function (h) {
                        return h.replace(/^"|"$/g, '').trim();
                    });

                    function buildOutLines(dateHeader, hoursHeader) {
                        var dateIdx = headers.indexOf(dateHeader);
                        var hoursIdx = headers.indexOf(hoursHeader);
                        if (dateIdx === -1 || hoursIdx === -1) return null;

                        var outLines = [];
                        for (var i = 1; i < lines.length; i++) {
                            var rowParts = lines[i].split(',');
                            if (rowParts.length < Math.max(dateIdx, hoursIdx) + 1) continue;

                            var dateVal = (rowParts[dateIdx] || '').replace(/^"|"$/g, '').trim();
                            var hoursVal = (rowParts[hoursIdx] || '').replace(/^"|"$/g, '').trim();
                            if (!dateVal) continue;

                            var hText = hoursVal.replace(',', '.'); // support 12,00 style
                            var hNum = parseFloat(hText);
                            if (isNaN(hNum)) hNum = 0;

                            outLines.push(dateVal + '\t' + hNum.toFixed(2));
                        }
                        if (!outLines.length) return null;
                        return outLines;
                    }

                    // Try original internal headers first, then simplified CSV
                    var outLines =
                        buildOutLines('txtTblDaily_ClockDate_1', 'txtTblDaily_TE40_24') ||
                        buildOutLines('Date', 'DEEME D MTH') ||
                        buildOutLines('Date', 'DEEME  D  MTH'); // tolerant of double spaces

                    if (outLines && outLines.length) {
                        var flatText = outLines.join('\n');

                        if (textarea) {
                            textarea.value = flatText;
                            textarea.disabled = false;
                            textarea.scrollTop = 0;
                        }

                        if (statusEl) {
                            statusEl.textContent = 'CSV processed. ' + outLines.length + ' rows loaded for validation.';
                            statusEl.classList.remove('text-red-600');
                            statusEl.classList.add('text-green-700');
                            statusEl.classList.remove('hidden');
                        }

                        enableAnalyze();
                        if (typeof showToast === 'function') {
                            showToast('CSV processed successfully. Tap "Analyze & Match" to validate.');
                        }
                        return;
                    }
                }

                // Fallback: not our expected CSV. Just drop raw text into the box.
                if (textarea) {
                    textarea.value = text;
                    textarea.disabled = false;
                    textarea.scrollTop = 0;
                }

                if (statusEl) {
                    statusEl.textContent = 'Report file loaded as plain text. If analysis fails, please export as CSV or paste the text from the system report.';
                    statusEl.classList.remove('text-green-700');
                    statusEl.classList.add('text-red-600');
                    statusEl.classList.remove('hidden');
                }

                enableAnalyze();
                if (typeof showToast === 'function') {
                    showToast('Report loaded as plain text. If the analyzer fails, please export as CSV or paste the text manually.', true);
                }
            } catch (err) {
                console.error('CSV/Text processing error:', err);

                if (textarea) {
                    textarea.disabled = false;
                }

                if (statusEl) {
                    statusEl.textContent = 'Error reading file: ' + err.message;
                    statusEl.classList.remove('text-green-700');
                    statusEl.classList.add('text-red-600');
                    statusEl.classList.remove('hidden');
                }

                enableAnalyze();
                if (typeof showToast === 'function') {
                    showToast('Failed to read the report file. Please try again or paste the text manually.', true);
                }
            }
        };

        reader.onerror = function () {
            if (statusEl) {
                statusEl.textContent = 'Failed to read file. Please try again.';
                statusEl.classList.remove('text-green-700');
                statusEl.classList.add('text-red-600');
                statusEl.classList.remove('hidden');
            }

            if (textarea) {
                textarea.disabled = false;
            }

            enableAnalyze();
            if (typeof showToast === 'function') {
                showToast('File read error. Please try another file or paste the text manually.', true);
            }
        };

        // Read the file purely as text
        reader.readAsText(file);
    });
})();

    


    


    // === PDF Upload -> Validation Text Bridge (DataExtractor-style) ===
    (function () {
        const pdfInput   = document.getElementById('pdf-upload');
        const statusEl   = document.getElementById('pdf-status');
        const textarea   = document.getElementById('validation-input');
        const analyzeBtn = document.getElementById('analyze-validation-btn');

        if (!pdfInput) return;

        function setStatus(msg, isError) {
            if (!statusEl) return;
            statusEl.textContent = msg || '';
            statusEl.classList.remove('hidden', 'text-red-600', 'text-green-700');
            statusEl.classList.add(isError ? 'text-red-600' : 'text-green-700');
        }

        function setAnalyzeEnabled(enabled) {
            if (!analyzeBtn) return;
            analyzeBtn.disabled = !enabled;
            if (enabled) {
                analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            } else {
                analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        async function processPdf(file) {
            if (!window.pdfjsLib) {
                setStatus('PDF reader not available. Please use Excel or paste text.', true);
                if (typeof showToast === 'function') {
                    showToast('PDF reader not available in this environment.', true);
                }
                return;
            }

            try {
                setStatus('Reading PDF...', false);
                setAnalyzeEnabled(false);
                if (textarea) {
                    textarea.value = '';
                    textarea.disabled = true;
                }

                const arrayBuffer = await file.arrayBuffer();
                const pdf = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let fullText = '';
                for (let p = 1; p <= pdf.numPages; p++) {
                    const page = await pdf.getPage(p);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(it => it.str || '').join(' ');
                    fullText += ' ' + pageText;
                }

                let clean = fullText
                    .replace(/[\r\n\t]+/g, ' ')
                    .replace(/,/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();

                const tokens = clean.split(' ').filter(t => t.length > 0);

                const dateRegex  = /^(\d{2}-\d{2}-\d{4})$/;         // 01-11-2025
                const hoursRegex = /^(\d{1,2}\.\d{2}|0\.00)$/;      // 12.00, 0.00, 11.00 etc.

                let pairs = [];
                let currentDate = null;

                for (const raw of tokens) {
                    const t = raw.trim();

                    const dm = t.match(dateRegex);
                    if (dm) {
                        currentDate = dm[1];
                        continue;
                    }

                    if (currentDate) {
                        const hm = t.match(hoursRegex);
                        if (hm) {
                            let hours = hm[1].replace(',', '.');
                            pairs.push(currentDate + '\t' + hours);
                            currentDate = null;
                        }
                    }
                }

                if (!pairs.length) {
                    setStatus('No (date, hours) pairs detected. Try Excel export or paste text.', true);
                    if (textarea) textarea.disabled = false;
                    setAnalyzeEnabled(true);
                    if (typeof showToast === 'function') {
                        showToast('PDF scanned, but no matching pairs found. Try Excel or manual text.', true);
                    }
                    return;
                }

                const flatText = pairs.join('\n');
                if (textarea) {
                    textarea.value = flatText;
                    textarea.disabled = false;
                    textarea.scrollTop = 0;
                }

                setStatus('PDF processed. ' + pairs.length + ' rows loaded. Tap "Analyze & Match".', false);
                setAnalyzeEnabled(true);

                if (typeof showToast === 'function') {
                    showToast('PDF processed. Review rows, then tap "Analyze & Match".');
                }
            } catch (err) {
                console.error('PDF processing error:', err);
                setStatus('PDF error: ' + (err.message || 'Failed to read file.'), true);
                if (textarea) textarea.disabled = false;
                setAnalyzeEnabled(true);
                if (typeof showToast === 'function') {
                    showToast('PDF extraction failed. Please use Excel or paste text.', true);
                }
            }
        }

        pdfInput.addEventListener('change', function (evt) {
            const file = evt.target.files && evt.target.files[0];
            if (!file) {
                if (statusEl) {
                    statusEl.textContent = '';
                    statusEl.classList.add('hidden');
                }
                if (textarea) textarea.disabled = false;
                setAnalyzeEnabled(true);
                return;
            }
            setStatus('Preparing to read PDF...', false);
            processPdf(file);
        });
    })();


</script>

    <script>
      // Option C: Method tab switching (Image / CSV / PDF / Paste)
      (function () {
        const tabs = document.querySelectorAll('[data-method-tab]');
        const panes = document.querySelectorAll('[data-method-pane]');
        if (!tabs.length || !panes.length) return;

        function setActive(method) {
          panes.forEach(pane => {
            const m = pane.getAttribute('data-method-pane');
            if (m === method) {
              pane.classList.remove('hidden');
            } else {
              pane.classList.add('hidden');
            }
          });

          tabs.forEach(tab => {
            const m = tab.getAttribute('data-method-tab');
            const isActive = (m === method);
            tab.classList.toggle('bg-blue-50', isActive);
            tab.classList.toggle('border-blue-300', isActive);
            tab.classList.toggle('text-blue-800', isActive);
            tab.classList.toggle('shadow-sm', isActive);

            tab.classList.toggle('bg-white', !isActive);
            tab.classList.toggle('border-gray-300', !isActive);
            tab.classList.toggle('text-gray-600', !isActive);
          });
        }

        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            const method = tab.getAttribute('data-method-tab');
            setActive(method);
          });
        });

        // default to image method
        setActive('image');
      })();
    </script>

            <!-- Attendance Server quick access (no iframe) -->
            <section class="mt-10">
              <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-200">
                  <div>
                    <h2 class="text-sm font-semibold text-gray-800">Attendance Server (New Tab)</h2>
                    <p class="text-[11px] text-gray-500">
                      Open the <span class="font-mono">Flexible Attendance Report</span> in a new browser tab,
                      export your PDF there, then return here and use <strong>Option 2</strong> to import it.
                    </p>
                    <div class="mt-2 flex flex-wrap gap-2 items-center">
                      <a
                        id="open-attendance-new-tab-btn"
                        href="https://prosoft.unit4cloud.com/ASY/web/eAttendance/Report/ReportTemplateListingDailyAttendance_Edit.aspx?UserRoleType=S&NodeID=2410"
                        target="_blank"
                        rel="noopener"
                        class="inline-flex items-center px-3 py-1.5 rounded-lg bg-blue-600 text-white text-xs font-semibold shadow hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-blue-500"
                      >
                        Open Attendance Server in New Tab
                      </a>
                      <span class="text-[10px] text-gray-400">
                        Recommended on iPhone / iPad.
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </section>

    <script>
      // Open Attendance Server in a separate tab (recommended way to login / export CSV)
      (function () {
        const btn = document.getElementById('open-attendance-new-tab-btn');
        if (!btn) return;
        btn.addEventListener('click', function () {
          const url = 'https://prosoft.unit4cloud.com/ASY/web/eAttendance/Report/ReportTemplateListingDailyAttendance_Edit.aspx?UserRoleType=S&NodeID=2410';
          try {
            window.open(url, '_blank');
          } catch (e) {
            window.location.href = url;
          }
        });
      })();
    </script>

</body>
</html>
            

            